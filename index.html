<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Home Expanses</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
        <style>
            :root {
                --bg: #f4f6f9;
                --container-bg: white;
                --text: #333;
                --heading: #2c3e50;
                --border: #ddd;
                --stat-bg: #ecf0f1;
                --table-header: #f1f1f1;
                --input-border: #ccc;
                --no-data: #777;
                --shadow: rgba(0, 0, 0, 0.1);
                --calendar-bg: white;
                --calendar-text: #333;
                --calendar-border: #ddd;
                --calendar-day-bg: #e8f4fd;
            }
            body.dark-mode {
                --bg: #000000;
                --container-bg: #000000;
                --text: #e0e0e0;
                --heading: #f1f1f1;
                --border: #444;
                --stat-bg: #2d2d2d;
                --table-header: #333;
                --input-border: #555;
                --no-data: #999;
                --shadow: rgba(0, 0, 0, 0.4);
                --calendar-bg: #1e1e1e;
                --calendar-text: #e0e0e0;
                --calendar-border: #000000;
                --calendar-day-bg: #181919;
            }
            * {
                box-sizing: border-box;
                margin: 3px;
                padding: 0;
            }
            body {
                font-family: Arial, sans-serif;
                background: var(--bg);
                color: var(--text);
                line-height: 1.7;
            }
            .container {
                max-width: 1200px;
                margin: 20px auto;
                padding: 20px;
                background: var(--container-bg);
                border-radius: 10px;
                box-shadow: 0 0 15px var(--shadow);
            }
            header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                flex-wrap: wrap;
            }
            h1 {
                color: var(--heading);
                margin-bottom: 10px;
            }
            .header-controls {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            .profile-icon {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #3498db;
                color: white;
                display: flex;
                justify-content: center;
                align-items: center;
                font-weight: bold;
                cursor: pointer;
                font-size: 1.2em;
                background-size: cover;
                background-position: center;
            }
            .profile-dropdown {
                display: none;
                position: fixed;
                top: 0;
                right: 0;
                height: 60vh;
                width: 320px;
                background: var(--container-bg);
                border-left: 1px solid var(--border);
                box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
                padding: 30px 20px;
                z-index: 10000;
                overflow-y: auto;
                transform: translateX(100%);
                transition: transform 0.35s ease;
            }
            .profile-dropdown.show {
                border-radius: 3rem;
                margin-bottom: 2rem;
                margin-top: 2rem;
                margin-right: 2rem;
                display: block;
                transform: translateX(0);
            }
            select,
            button {
                padding: 6px 10px;
                border-radius: 12px;
                border: 2px solid var(--input-border);
                background: var(--container-bg);
                color: var(--text);
                font-size: 1rem;
            }
            button {
                background: #3498db;
                color: white;
                cursor: pointer;
            }
            button:hover {
                background: #2980b9;
            }
            .pdf-btn {
                background: #e74c3c;
            }
            .download-photo-btn {
                background: #27ae60;
                font-size: 0.8em;
                padding: 4px 8px;
                margin: 2px;
            }
            .edit-btn {
                background: #f39c12;
                font-size: 0.8em;
                padding: 4px 8px;
                margin: 2px;
            }
            .delete-btn {
                background: #e74c3c;
                font-size: 0.8em;
                padding: 4px 8px;
                margin: 2px;
            }
            .remove-photo-btn {
                background: #c0392b;
                font-size: 0.8em;
                padding: 3px 6px;
                margin: 2px;
            }
            .save-btn {
                background: #27ae60;
            }
            .cancel-btn {
                background: #95a5a6;
            }
            h2 {
                font-size: medium;
                background: #000000;
                color: white;
                padding: 12px;
                border-radius: 30px;
                margin: 30px 0 20px;
                text-align: center;
            }
            .tabs {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 20px;
            }
            .tab-btn {
                flex: 1;
                padding: 12px;
                background: #3498db;
                color: white;
                border: none;
                border-radius: 18px;
                cursor: pointer;
                text-align: center;
            }
            .tab-btn.active {
                background: #2c3e50;
            }
            form {
                display: flow;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                padding: 20px;
                background: var(--stat-bg);
                border-radius: 18px;
                margin-bottom: 30px;
            }
            input,
            select {
                padding: 10px;
                border: 1px solid var(--input-border);
                border-radius: 8px;
                width: 100%;
            }
            .filter {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                flex-wrap: wrap;
                align-items: center;
                font-size: 0.9em;
                justify-content: flex-start;
            }
            .filter label {
                margin-right: 5px;
                white-space: nowrap;
            }
            .filter select {
                padding: 5px 8px;
                font-size: 0.9em;
                max-width: 150px;
            }
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin: 30px 0;
            }
            .stat {
                background: var(--stat-bg);
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }
            .stat h3 {
                margin-bottom: 10px;
            }
            .stat p {
                font-size: 1.8em;
                font-weight: bold;
                color: #e74c3c;
            }
            .chart-container {
                margin: 30px 0;
                height: 300px;
            }
            .no-data {
                text-align: center;
                padding: 40px;
                color: var(--no-data);
                font-style: italic;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
            }
            th,
            td {
                padding: 10px;
                border: 1px solid var(--border);
                text-align: left;
                font-size: 0.9em;
            }
            th {
                background: var(--table-header);
            }
            .amount {
                text-align: right;
            }
            .actions {
                text-align: center;
                white-space: nowrap;
            }
            .photo-preview {
                max-width: 80px;
                max-height: 80px;
                margin: 2px;
                border-radius: 4px;
                object-fit: cover;
                cursor: pointer;
            }
            .photo-gallery {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin: 5px 0;
            }
            .photo-wrapper {
                position: relative;
                display: inline-block;
            }
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }
            .modal-content {
                max-width: 90%;
                text-align: center;
            }
            .close-modal {
                position: absolute;
                top: 20px;
                right: 30px;
                font-size: 40px;
                cursor: pointer;
                color: white;
            }
            .calendar-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                background: #2c3e50;
                color: white;
                font-weight: bold;
                text-align: center;
            }
            .calendar-header div {
                padding: 10px;
            }
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
                margin-top: 10px;
            }
            .calendar-day {
                min-height: 100px;
                background: var(--calendar-bg);
                border: 1px solid var(--calendar-border);
                padding: 5px;
                font-size: 0.9em;
                color: var(--calendar-text);
            }
            .calendar-day.other-month {
                opacity: 0.5;
            }
            .calendar-day.has-entry {
                background: var(--calendar-day-bg);
            }
            .day-number {
                font-weight: bold;
                color: var(--calendar-text);
            }
            .day-entries {
                font-size: 0.8em;
                margin-top: 5px;
                line-height: 1.3;
                color: var(--calendar-text);
            }
            .month-separator {
                margin: 40px 0 20px;
                border-top: 2px solid var(--border);
                padding-top: 10px;
                font-weight: bold;
                font-size: 1.3em;
                text-align: left;
            }
            #login-page,
            #signup-page {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #dfe3f3;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }
            .auth-box {
                background: var(--container-bg);
                padding: 40px;
                border-radius: 30px;
                width: 400px;
                text-align: center;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            }
            .auth-link {
                margin-top: 20px;
                color: #3498db;
                cursor: pointer;
            }
            #main-app {
                display: none;
            }
            .sync-status {
                text-align: center;
                font-size: 0.9em;
                margin: 10px 0;
                color: #27ae60;
            }
            .sync-status {
                text-align: center;
                font-size: 1em;
                margin: 15px 0;
                padding: 12px;
                border-radius: 10px;
                background: #d4edda;
                color: #155724;
                font-weight: 500;
            }
            .logout-btn {
                background: #e74c3c;
            }
            .delete-account-btn {
                background: #c0392b;
                margin-top: 15px;
            }
            .version-info {
                font-size: 0.8em;
                color: #777;
                margin-top: 20px;
            }
            .profile-photo {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                object-fit: cover;
                margin-bottom: 10px;
            }
            #edit-profile-modal {
                display: none;
            }
            #edit-profile-modal .modal-content {
                background: var(--container-bg);
                padding: 20px;
                border-radius: 8px;
                width: 400px;
            }
            .cropper-container {
                width: 300px;
                height: 300px;
                border: 2px dashed #ccc;
                margin: 10px auto;
                overflow: hidden;
                position: relative;
                display: none;
            }
            .cropper-image {
                max-width: 100%;
                max-height: 100%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            .size-selector {
                margin: 10px 0;
            }
            .size-selector label {
                margin-right: 10px;
            }
        </style>
    </head>
    <body>
        <!-- Signup Page -->
        <div id="signup-page" style="display:none;">
            <div class="auth-box">
                <h2>Create Account</h2>
                <form id="signup-form">
                    <input type="text" id="signup-firstname" placeholder="First Name" required>
                    <input type="text" id="signup-lastname" placeholder="Last Name" required>
                    <input type="tel" id="signup-contact" placeholder="Contact Number (optional)">
                    <input type="email" id="signup-email" placeholder="Email ID" required>
                    <input type="password" id="signup-password" placeholder="Password" required>
                    <input type="password" id="signup-confirm" placeholder="Confirm Password" required>
                    <button type="submit">Create Account</button>
                </form>
                <div class="auth-link" onclick="showLogin()">Already have an account? Login</div>
                <p id="signup-error" style="color:red; margin-top:15px; display:none;"></p>
            </div>
        </div>
        <!-- Login Page -->
        <div id="login-page">
            <div class="auth-box">
                <h2>Home Expanses Login</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
                <div class="auth-link" onclick="showSignup()">Create new account</div>
                <p id="login-error" style="color:red; margin-top:15px; display:none;"></p>
            </div>
        </div>
        <div id="main-app" class="container">
            <header>
                <h1>Home Expanses</h1>
                <div class="header-controls">
                    <select id="language-select" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="hi">हिंदी</option>
                        <option value="gu">ગુજરાતી</option>
                    </select>
                    <button onclick="toggleTheme()">Dark Mode</button>
                    <div class="profile-icon" id="profile-icon" onclick="toggleProfile()"></div>
                </div>
            </header>
            <div id="profile-dropdown" class="profile-dropdown">
                <h3 style="text-align: center; font-size: xx-large; ">User Profile</h3>
                <div id="profile-info"></div>
                <button onclick="openEditProfile()">Edit Profile</button>
                <button class="delete-account-btn" onclick="deleteAccount()">Delete Account</button>
                <hr>
                <button id="logout-btn" class="logout-btn">Logout</button>
                <div class="version-info">App Version: 0.0.0.1</div>
            </div>
            <div class="sync-status" id="sync-status">Loading data...</div>
            <section class="tabs">
                <button class="tab-btn active" onclick="openTab('dashboard')" data-lang="Dashboard">Dashboard</button>
                <button class="tab-btn" onclick="openTab('milk')" data-lang="add_milk">Add Milk</button>
                <button class="tab-btn" onclick="openTab('water')" data-lang="add_water">Add Water</button>
                <button class="tab-btn" onclick="openTab('extra')" data-lang="add_extra">Add Extra Expense</button>
                <button class="tab-btn" onclick="openTab('credit')" data-lang="add_credit">Add Credit Balance</button>
                <button class="tab-btn" onclick="openTab('papad')" data-lang="add_papad">Add Papad Expense</button>
                <button class="tab-btn" onclick="openTab('calendar')" data-lang="calendar_view">Calendar View</button>
                <button class="tab-btn" onclick="openTab('lists')" data-lang="list_view">List View</button>
            </section>
            <!-- Dashboard -->
            <section id="dashboard" class="tab-content">
                <div class="filter">
                    <label data-lang="filter_month">Month:</label>
                    <select id="dashboard-month" onchange="updateDashboard()"></select>
                    <label data-lang="filter_year">Year:</label>
                    <select id="dashboard-year" onchange="updateDashboard()"></select>
                    <div style="margin-left: auto;">
                        <button class="pdf-btn" onclick="generateMilkPDF()" data-lang="download_milk_pdf">Milk
                            PDF</button>
                        <button class="pdf-btn" onclick="generateWaterPDF()" data-lang="download_water_pdf">Water
                            PDF</button>
                        <button class="pdf-btn" onclick="generateExtraPDF()" data-lang="download_extra_pdf">Extra
                            PDF</button>
                        <button class="pdf-btn" onclick="generatePapadPDF()">Papad PDF</button>
                    </div>
                </div>
                <div class="stats">
                    <div class="stat">
                        <h3 data-lang="total_milk_ltr">Total Milk (Ltr)</h3>
                        <p id="dash-milk-ltr">0</p>
                    </div>
                    <div class="stat">
                        <h3 data-lang="milk_expense">Milk Expense</h3>
                        <p id="dash-milk-amt">Rs 0</p>
                    </div>
                    <div class="stat">
                        <h3 data-lang="total_water_btl">Total Water (Btl)</h3>
                        <p id="dash-water-btl">0</p>
                    </div>
                    <div class="stat">
                        <h3 data-lang="water_expense">Water Expense</h3>
                        <p id="dash-water-amt">Rs 0</p>
                    </div>
                    <div class="stat">
                        <h3 data-lang="extra_expense">Extra Expenses</h3>
                        <p id="dash-extra-amt">Rs 0</p>
                    </div>
                    <div class="stat">
                        <h3>Papad Expenses</h3>
                        <p id="dash-papad-amt">Rs 0</p>
                    </div>
                    <div class="stat">
                        <h3>Total Credits</h3>
                        <p id="dash-credit-amt">Rs 0</p>
                    </div>
                    <div class="stat">
                        <h3 data-lang="total_expense">Grand Total</h3>
                        <p id="dash-total">Rs 0</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </section>
            <!-- Add Forms -->
            <section id="milk" class="tab-content" style="display:none;">
                <h2 data-lang="add_milk">Add Milk Purchase</h2>
                <form id="milk-form">
                    <input type="date" id="milk-date" required>
                    <input type="number" id="milk-qty" placeholder="Quantity (Liters)" min="0" step="0.5" required>
                    <div><strong data-lang="milk_price">Fixed Price: Rs 60 per Liter</strong>
                        <div class="auto-amount" id="milk-total">Total: Rs 0</div>
                    </div>
                    <button type="submit" data-lang="add_milk_btn">Add Milk Entry</button>
                </form>
            </section>
            <section id="water" class="tab-content" style="display:none;">
                <h2 data-lang="add_water">Add Water Purchase</h2>
                <form id="water-form">
                    <input type="date" id="water-date" required>
                    <input type="number" id="water-qty" placeholder="Quantity (Bottles)" min="1" step="1" required>
                    <div><strong data-lang="water_price">Fixed Price: Rs 15 per Bottle</strong>
                        <div class="auto-amount" id="water-total">Total: Rs 0</div>
                    </div>
                    <button type="submit" data-lang="add_water_btn">Add Water Entry</button>
                </form>
            </section>
            <section id="extra" class="tab-content" style="display:none;">
                <h2 data-lang="add_extra">Add Extra Expense</h2>
                <form id="extra-form">
                    <input type="date" id="extra-date" required>
                    <select id="extra-category" required>
                        <option value="" disabled selected>Select Category</option>
                        <option>Utensils</option>
                        <option>Repairs</option>
                        <option>Electricity Bill</option>
                        <option>Mobile Bill</option>
                        <option>Gas Bill</option>
                        <option>Event</option>
                        <option>Grocery</option>
                        <option>Other</option>
                    </select>
                    <input type="text" id="extra-desc" placeholder="Description" required>
                    <input type="number" id="extra-amount" placeholder="Amount (Rs)" min="0" step="0.01" required>
                    <input type="file" id="extra-photos" accept="image/*" multiple>
                    <div id="extra-photo-preview" class="photo-gallery"></div>
                    <button type="submit" class="save-btn" data-lang="add_extra_btn">Add Extra Expense</button>
                </form>
            </section>
            <!-- Add Credit Balance -->
            <section id="credit" class="tab-content" style="display:none;">
                <h2 data-lang="add_credit">Add Credit Balance</h2>
                <form id="credit-form">
                    <input type="date" id="credit-date" required>
                    <input type="text" id="credit-name" placeholder="Full Name" required>
                    <input type="tel" id="credit-contact" placeholder="Contact Number" required>
                    <select id="credit-category" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="client">Client</option>
                        <option value="salary">Salary</option>
                        <option value="business">Business</option>
                        <option value="others">Others</option>
                    </select>
                    <select id="credit-mode" required>
                        <option value="" disabled selected>Select Mode</option>
                        <option value="cash">Cash</option>
                        <option value="G-Pay">G-Pay</option>
                        <option value="online">Online</option>
                        <option value="BT">BT</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="file" id="credit-photo" accept="image/*">
                    <div id="credit-photo-preview" class="photo-gallery"></div>
                    <input type="text" id="credit-remarks" placeholder="Remarks (optional)">
                    <input type="number" id="credit-amount" placeholder="Amount (₹)" min="0" step="0.01" required>
                    <button type="submit">Submit</button>
                </form>
                <h2>View Credit Balances</h2>
                <div class="filter">
                    <label>Month:</label>
                    <select id="credit-month" onchange="renderCreditList()"></select>
                    <label>Year:</label>
                    <select id="credit-year" onchange="renderCreditList()"></select>
                    <label>Category:</label>
                    <select id="credit-filter-category" onchange="renderCreditList()">
                        <option value="all">All</option>
                        <option value="client">Client</option>
                        <option value="salary">Salary</option>
                        <option value="business">Business</option>
                        <option value="others">Others</option>
                    </select>
                </div>
                <div id="credit-list"></div>
            </section>
            <!-- Add Papad Expense -->
            <section id="papad" class="tab-content" style="display:none;">
                <h2>Add Papad Expense</h2>
                <form id="papad-form">
                    <input type="date" id="papad-date" required>
                    <select id="papad-category" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Utensils">Utensils</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Event">Event</option>
                        <option value="Bills">Bills</option>
                        <option value="Medicine">Medicine</option>
                        <option value="others">Others</option>
                    </select>
                    <select id="papad-mode" required>
                        <option value="" disabled selected>Select Mode</option>
                        <option value="cash">Cash</option>
                        <option value="G-Pay">G-Pay</option>
                        <option value="online">Online</option>
                        <option value="BT">BT</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="file" id="papad-photo" accept="image/*">
                    <div id="papad-photo-preview" class="photo-gallery"></div>
                    <input type="text" id="papad-remarks" placeholder="Remarks (optional)">
                    <input type="number" id="papad-amount" placeholder="Amount (₹)" min="0" step="0.01" required>
                    <button type="submit">Submit</button>
                </form>
                <h2>View Papad Expenses</h2>
                <div class="filter">
                    <label>Month:</label>
                    <select id="papad-month" onchange="renderPapadList()"></select>
                    <label>Year:</label>
                    <select id="papad-year" onchange="renderPapadList()"></select>
                </div>
                <div id="papad-list"></div>
            </section>
            <!-- Calendar View -->
            <section id="calendar" class="tab-content" style="display:none;">
                <div class="filter">
                    <label data-lang="filter_month">Month:</label>
                    <select id="cal-month" onchange="renderCalendar()"></select>
                    <label data-lang="filter_year">Year:</label>
                    <select id="cal-year" onchange="renderCalendar()"></select>
                </div>
                <div id="calendar-container"></div>
            </section>
            <!-- List View -->
            <section id="lists" class="tab-content" style="display:none;">
                <div class="filter">
                    <label data-lang="filter_month">Month:</label>
                    <select id="list-month" onchange="renderLists()"></select>
                    <label data-lang="filter_year">Year:</label>
                    <select id="list-year" onchange="renderLists()"></select>
                </div>
                <h2 data-lang="milk_entries">Milk Entries</h2>
                <div id="milk-list"></div>
                <h2 data-lang="water_entries">Water Entries</h2>
                <div id="water-list"></div>
                <h2 data-lang="extra_entries">Extra Expenses</h2>
                <div id="extra-total" class="month-total" style="display:none;"></div>
                <div id="extra-list"></div>
                <h2>Credit Balances</h2>
                <div id="credit-total" class="month-total" style="display:none;"></div>
                <div id="credit-list-short"></div>
                <h2>Papad Expenses</h2>
                <div id="papad-total" class="month-total" style="display:none;"></div>
                <div id="papad-list-short"></div>
                <div id="list-grand-total" class="grand-total" style="display:none;"></div>
            </section>
        </div>
        <div id="photo-modal" class="modal" onclick="this.style.display='none'">
            <span class="close-modal">&times;</span>
            <div class="modal-content">
                <img id="modal-photo" style="max-width:90%; max-height:80vh;" src="" alt="Photo">
            </div>
        </div>
        <div id="edit-profile-modal" class="modal" onclick="closeEditProfile()">
            <div class="modal-content" onclick="event.stopPropagation();">
                <h2>Edit Profile</h2>
                <form id="edit-profile-form">
                    <input type="text" id="edit-firstname" placeholder="First Name" required>
                    <input type="text" id="edit-lastname" placeholder="Last Name" required>
                    <input type="tel" id="edit-contact" placeholder="Contact Number">
                    <label>Profile Photo Size:</label>
                    <select id="photo-size" class="size-selector">
                        <option value="100">100x100 px</option>
                        <option value="150">150x150 px</option>
                        <option value="200">200x200 px</option>
                    </select>
                    <input type="file" id="edit-photo" accept="image/*">
                    <div class="cropper-container" id="cropper-container">
                        <img class="cropper-image" id="cropper-image">
                    </div>
                    <img id="edit-photo-preview" class="profile-photo" style="display:none;">
                    <button type="button" id="remove-photo-btn" class="remove-photo-btn" style="display:none;">Remove Photo</button>
                    <button type="submit">Save</button>
                    <button type="button" onclick="closeEditProfile()">Cancel</button>
                </form>
            </div>
        </div>
        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyCCFs97XtLPQE3nASwvtLBUcfH6E8-SIns",
                authDomain: "studio-7486561707-a8f94.firebaseapp.com",
                projectId: "studio-7486561707-a8f94",
                storageBucket: "studio-7486561707-a8f94.firebasestorage.app",
                messagingSenderId: "671038061779",
                appId: "1:671038061779:web:1fc69c9d4e47bc373f6826"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const storage = firebase.storage();
            const USERS_COLLECTION = "users";
            let milkEntries = [], waterEntries = [], extraEntries = [], creditEntries = [], papadEntries = [];
            let currentUser = null;
            let monthlyChart = null;
            const MILK_PRICE = 60, WATER_PRICE = 15;
            const ADMIN_EMAIL = "homexpanse09@gmail.com";
            const translations = {
                en: {
                    Dashboard: "Dashboard",
                    add_milk: "Add Milk",
                    add_water: "Add Water",
                    add_extra: "Add Extra Expense",
                    add_credit: "Add Credit Balance",
                    add_papad: "Add Papad Expense",
                    calendar_view: "Calendar View",
                    list_view: "List View",
                    filter_month: "Month:",
                    filter_year: "Year:",
                    total_milk_ltr: "Total Milk (Ltr)",
                    milk_expense: "Milk Expense",
                    total_water_btl: "Total Water (Btl)",
                    water_expense: "Water Expense",
                    extra_expense: "Extra Expenses",
                    total_expense: "Grand Total",
                    milk_entries: "Milk Entries",
                    water_entries: "Water Entries",
                    extra_entries: "Extra Expenses",
                    download_milk_pdf: "Milk PDF",
                    download_water_pdf: "Water PDF",
                    download_extra_pdf: "Extra PDF",
                    milk_price: "Fixed Price: Rs 60 per Liter",
                    water_price: "Fixed Price: Rs 15 per Bottle",
                    add_milk_btn: "Add Milk Entry",
                    add_water_btn: "Add Water Entry",
                    add_extra_btn: "Add Extra Expense"
                },
                hi: {
                    Dashboard: "डैशबोर्ड",
                    add_milk: "दूध जोड़ें",
                    add_water: "पानी जोड़ें",
                    add_extra: "अतिरिक्त खर्च जोड़ें",
                    add_credit: "क्रेडिट बैलेंस जोड़ें",
                    add_papad: "पापड़ खर्च जोड़ें",
                    calendar_view: "कैलेंडर दृश्य",
                    list_view: "सूची दृश्य",
                    filter_month: "माह:",
                    filter_year: "वर्ष:",
                    total_milk_ltr: "कुल दूध (लीटर)",
                    milk_expense: "दूध खर्च",
                    total_water_btl: "कुल पानी (बोतल)",
                    water_expense: "पानी खर्च",
                    extra_expense: "अतिरिक्त खर्च",
                    total_expense: "कुल योग",
                    milk_entries: "दूध प्रविष्टियाँ",
                    water_entries: "पानी प्रविष्टियाँ",
                    extra_entries: "अतिरिक्त खर्च",
                    milk_price: "निश्चित मूल्य: Rs 60 प्रति लीटर",
                    water_price: "निश्चित मूल्य: Rs 15 प्रति बोतल",
                    add_milk_btn: "दूध प्रविष्टि जोड़ें",
                    add_water_btn: "पानी प्रविष्टि जोड़ें",
                    add_extra_btn: "अतिरिक्त खर्च जोड़ें"
                },
                gu: {
                    Dashboard: "ડૅશબોર્ડ",
                    add_milk: "દૂધ ઉમેરો",
                    add_water: "પાણી ઉમેરો",
                    add_extra: "અતિરિક્ત ખર્ચ ઉમેરો",
                    add_credit: "ક્રેડિટ બેલેન્સ ઉમેરો",
                    add_papad: "પાપડ ખર્ચ ઉમેરો",
                    calendar_view: "કૅલેન્ડર દૃશ્ય",
                    list_view: "યાદી દૃશ્ય",
                    filter_month: "મહિનો:",
                    filter_year: "વર્ષ:",
                    total_milk_ltr: "કુલ દૂધ (લિટર)",
                    milk_expense: "દૂધ ખર્ચ",
                    total_water_btl: "કુલ પાણી (બોટલ)",
                    water_expense: "પાણી ખર્ચ",
                    extra_expense: "અતિરિક્ત ખર્ચ",
                    total_expense: "કુલ યોગ",
                    milk_entries: "દૂધ એન્ટ્રીઓ",
                    water_entries: "પાણી એન્ટ્રીઓ",
                    extra_entries: "અતિરિક્ત ખર્ચ",
                    milk_price: "નિશ્ચિત કિંમત: Rs 60 પ્રતિ લિટર",
                    water_price: "નિશ્ચિત કિંમત: Rs 15 પ્રતિ બોટલ",
                    add_milk_btn: "દૂધ એન્ટ્રી ઉમેરો",
                    add_water_btn: "પાણી એન્ટ્રી ઉમેરો",
                    add_extra_btn: "અતિરિક્ત ખર્ચ ઉમેરો"
                }
            };
            let currentLang = 'en';
            function showSignup() {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('signup-page').style.display = 'flex';
            }
            function showLogin() {
                document.getElementById('signup-page').style.display = 'none';
                document.getElementById('login-page').style.display = 'flex';
            }
            document.getElementById('signup-form').addEventListener('submit', async e => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;
                if (password !== confirm) {
                    document.getElementById('signup-error').textContent = "Passwords do not match";
                    document.getElementById('signup-error').style.display = 'block';
                    return;
                }
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;
                    await db.collection(USERS_COLLECTION).doc(uid).set({
                        firstName: document.getElementById('signup-firstname').value.trim(),
                        lastName: document.getElementById('signup-lastname').value.trim(),
                        contact: document.getElementById('signup-contact').value.trim(),
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Account created successfully!");
                    showLogin();
                } catch (err) {
                    document.getElementById('signup-error').textContent = err.message;
                    document.getElementById('signup-error').style.display = 'block';
                }
            });
            document.getElementById('login-form').addEventListener('submit', async e => {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    document.getElementById('login-error').textContent = "Invalid email or password";
                    document.getElementById('login-error').style.display = 'block';
                }
            });
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('signup-page').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    await loadUserProfile();
                    await loadData();
                } else {
                    currentUser = null;
                    document.getElementById('main-app').style.display = 'none';
                    document.getElementById('login-page').style.display = 'flex';
                }
            });
            async function loadUserProfile() {
                const doc = await db.collection(USERS_COLLECTION).doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    const profileIcon = document.getElementById('profile-icon');
                    if (data.profilePhoto) {
                        profileIcon.style.backgroundImage = `url(${data.profilePhoto})`;
                        profileIcon.textContent = '';
                    } else {
                        profileIcon.style.backgroundImage = '';
                        profileIcon.textContent = (data.firstName.charAt(0) + data.lastName.charAt(0)).toUpperCase();
                    }
                    let photoHtml = '';
                    if (data.profilePhoto) {
                        photoHtml = `<img src="${data.profilePhoto}" class="profile-photo" alt="Profile Photo">`;
                    }
                    document.getElementById('profile-info').innerHTML = `
                    ${photoHtml}
                    <p><strong>Name:</strong> ${data.firstName} ${data.lastName}</p>
                    <p><strong>Email:</strong> ${data.email}</p>
                    <p><strong>Contact:</strong> ${data.contact || '-'}</p>
                    <p><strong>User ID:</strong> ${currentUser.uid}</p>
                `;
                }
            }
            function toggleProfile() {
                const dropdown = document.getElementById('profile-dropdown');
                dropdown.classList.toggle('show');
            }
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('profile-dropdown');
                const icon = document.getElementById('profile-icon');
                if (dropdown.classList.contains('show') && !dropdown.contains(e.target) && !icon.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
            function openEditProfile() {
                const modal = document.getElementById('edit-profile-modal');
                modal.style.display = 'flex';
                const cropperContainer = document.getElementById('cropper-container');
                cropperContainer.style.display = 'none';
                db.collection(USERS_COLLECTION).doc(currentUser.uid).get().then(snap => {
                    const data = snap.data();
                    document.getElementById('edit-firstname').value = data.firstName;
                    document.getElementById('edit-lastname').value = data.lastName;
                    document.getElementById('edit-contact').value = data.contact || '';
                    const preview = document.getElementById('edit-photo-preview');
                    const removeBtn = document.getElementById('remove-photo-btn');
                    if (data.profilePhoto) {
                        preview.src = data.profilePhoto;
                        preview.style.display = 'block';
                        removeBtn.style.display = 'inline-block';
                    } else {
                        preview.style.display = 'none';
                        removeBtn.style.display = 'none';
                    }
                });
                const fileInput = document.getElementById('edit-photo');
                fileInput.value = '';
                fileInput.addEventListener('change', handlePhotoChange, { once: true });
            }
            function handlePhotoChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    const img = document.getElementById('cropper-image');
                    img.src = ev.target.result;
                    const container = document.getElementById('cropper-container');
                    container.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
            function resizeImage(dataUrl, size) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, size, size);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = dataUrl;
                });
            }
            function closeEditProfile() {
                document.getElementById('edit-profile-modal').style.display = 'none';
                const fileInput = document.getElementById('edit-photo');
                fileInput.removeEventListener('change', handlePhotoChange);
            }
            document.getElementById('edit-profile-form').addEventListener('submit', async e => {
                e.preventDefault();
                const size = parseInt(document.getElementById('photo-size').value);
                let profilePhoto = null;
                const container = document.getElementById('cropper-container');
                if (container.style.display !== 'none') {
                    const img = document.getElementById('cropper-image');
                    profilePhoto = await resizeImage(img.src, size);
                } else {
                    const preview = document.getElementById('edit-photo-preview');
                    if (preview.style.display !== 'none') {
                        profilePhoto = preview.src;
                    }
                }
                const updates = {
                    firstName: document.getElementById('edit-firstname').value.trim(),
                    lastName: document.getElementById('edit-lastname').value.trim(),
                    contact: document.getElementById('edit-contact').value.trim()
                };
                if (profilePhoto) {
                    updates.profilePhoto = profilePhoto;
                } else {
                    updates.profilePhoto = firebase.firestore.FieldValue.delete();
                }
                await db.collection(USERS_COLLECTION).doc(currentUser.uid).update(updates);
                loadUserProfile();
                closeEditProfile();
            });
            document.getElementById('remove-photo-btn').addEventListener('click', () => {
                document.getElementById('edit-photo-preview').style.display = 'none';
                document.getElementById('remove-photo-btn').style.display = 'none';
                document.getElementById('edit-photo').value = '';
                document.getElementById('cropper-container').style.display = 'none';
            });
            function deleteAccount() {
                if (confirm("Are you sure you want to delete your account? This cannot be undone.")) {
                    db.collection(USERS_COLLECTION).doc(currentUser.uid).delete().then(() => {
                        currentUser.delete().then(() => {
                            alert("Account deleted");
                        });
                    });
                }
            }
            document.getElementById('logout-btn').addEventListener('click', () => {
                auth.signOut();
            });
            async function loadData() {
                if (!currentUser) return;
                try {
                    const docRef = db.collection(`users/${currentUser.uid}/expenses`).doc('data');
                    const doc = await docRef.get();
                    if (doc.exists) {
                        data = doc.data();
                        milkEntries = data.milkEntries || [];
                        waterEntries = data.waterEntries || [];
                        extraEntries = data.extraEntries || [];
                        creditEntries = data.creditEntries || [];
                        papadEntries = data.papadEntries || [];
                    } else {
                        milkEntries = [];
                        waterEntries = [];
                        extraEntries = [];
                        creditEntries = [];
                        papadEntries = [];
                    }
                    document.getElementById('sync-status').textContent = "Data loaded successfully!";
                    document.getElementById('sync-status').style.color = "#27ae60";
                } catch (err) {
                    console.error("Load error:", err);
                    document.getElementById('sync-status').textContent = "Offline – changes will sync later";
                    document.getElementById('sync-status').style.color = "#e67e22";
                }
                initApp();
            }
            async function saveData() {
                if (!currentUser) return;
                try {
                    await db.collection(`users/${currentUser.uid}/expenses`).doc('data').set({
                        milkEntries,
                        waterEntries,
                        extraEntries,
                        creditEntries,
                        papadEntries
                    });
                } catch (err) {
                    console.error("Save error:", err);
                }
            }
            function initApp() {
                const today = new Date().toISOString().split('T')[0];
                ['milk', 'water', 'extra', 'credit', 'papad'].forEach(id => {
                    const el = document.getElementById(id + '-date');
                    if (el) el.value = today;
                });
                currentLang = localStorage.getItem('preferredLanguage') || 'en';
                document.getElementById('language-select').value = currentLang;
                translatePage();
                populateYearMonthSelects();
                populateCreditPapadSelects();
                openTab('dashboard');
            }
            function translatePage() {
                document.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.getAttribute('data-lang');
                    if (translations[currentLang] && translations[currentLang][key]) {
                        el.textContent = translations[currentLang][key];
                    }
                });
                populateYearMonthSelects();
                populateCreditPapadSelects();
                if (document.getElementById('calendar').style.display === 'block') renderCalendar();
                if (document.getElementById('lists').style.display === 'block') renderLists();
            }
            function changeLanguage() {
                currentLang = document.getElementById('language-select').value;
                localStorage.setItem('preferredLanguage', currentLang);
                translatePage();
                updateDashboard();
            }
            function populateYearMonthSelects() {
                const years = new Set([new Date().getFullYear()]);
                [...milkEntries, ...waterEntries, ...extraEntries, ...creditEntries, ...papadEntries].forEach(e => {
                    const d = new Date(e.date);
                    years.add(d.getFullYear());
                });
                ['dashboard', 'cal', 'list'].forEach(prefix => {
                    const yearSel = document.getElementById(prefix + '-year');
                    const monthSel = document.getElementById(prefix + '-month');
                    if (!yearSel || !monthSel) return;
                    yearSel.innerHTML = `<option value="all">All Years</option>`;
                    monthSel.innerHTML = `<option value="all">All Months</option>`;
                    Array.from(years).sort((a, b) => b - a).forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y; opt.textContent = y;
                        if (y === new Date().getFullYear()) opt.selected = true;
                        yearSel.appendChild(opt);
                    });
                    for (let i = 0; i < 12; i++) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = new Date(2020, i).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long' });
                        if (i === new Date().getMonth()) opt.selected = true;
                        monthSel.appendChild(opt);
                    };
                });
            }
            function populateCreditPapadSelects() {
                const years = new Set([new Date().getFullYear()]);
                [...creditEntries, ...papadEntries].forEach(e => {
                    const d = new Date(e.date);
                    years.add(d.getFullYear());
                });
                ['credit', 'papad'].forEach(prefix => {
                    const yearSel = document.getElementById(prefix + '-year');
                    const monthSel = document.getElementById(prefix + '-month');
                    if (!yearSel || !monthSel) return;
                    yearSel.innerHTML = `<option value="all">All Years</option>`;
                    monthSel.innerHTML = `<option value="all">All Months</option>`;
                    Array.from(years).sort((a, b) => b - a).forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y; opt.textContent = y;
                        if (y === new Date().getFullYear()) opt.selected = true;
                        yearSel.appendChild(opt);
                    });
                    for (let i = 0; i < 12; i++) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.textContent = new Date(2020, i).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long' });
                        if (i === new Date().getMonth()) opt.selected = true;
                        monthSel.appendChild(opt);
                    };
                });
            }
            const extraPhotosInput = document.getElementById('extra-photos');
            if (extraPhotosInput) {
                extraPhotosInput.addEventListener('change', e => {
                    const files = e.target.files;
                    const preview = document.getElementById('extra-photo-preview');
                    if (!preview) return;
                    preview.innerHTML = '';
                    Array.from(files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            const img = document.createElement('img');
                            img.src = ev.target.result;
                            img.className = 'photo-preview';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    });
                });
            }
            const extraForm = document.getElementById('extra-form');
            if (extraForm) {
                extraForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const files = document.getElementById('extra-photos').files;
                    const photos = [];
                    for (let file of files) {
                        const dataUrl = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                        photos.push(dataUrl);
                    }
                    extraEntries.push({
                        date: document.getElementById('extra-date').value,
                        category: document.getElementById('extra-category').value,
                        description: document.getElementById('extra-desc').value.trim(),
                        amount: parseFloat(document.getElementById('extra-amount').value),
                        photos: photos
                    });
                    await saveData();
                    e.target.reset();
                    document.getElementById('extra-photo-preview').innerHTML = '';
                    renderLists();
                    updateDashboard();
                });
            }
            ['milk', 'water'].forEach(type => {
                const qtyInput = document.getElementById(type + '-qty');
                if (qtyInput) {
                    qtyInput.addEventListener('input', () => {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const price = type === 'milk' ? MILK_PRICE : WATER_PRICE;
                        const totalEl = document.getElementById(type + '-total');
                        if (totalEl) totalEl.textContent = `Total: Rs ${(qty * price).toFixed(2)}`;
                    });
                }
                const form = document.getElementById(type + '-form');
                if (form) {
                    form.addEventListener('submit', async e => {
                        e.preventDefault();
                        const qty = parseFloat(document.getElementById(type + '-qty').value);
                        const entries = type === 'milk' ? milkEntries : waterEntries;
                        const price = type === 'milk' ? MILK_PRICE : WATER_PRICE;
                        entries.push({
                            date: document.getElementById(type + '-date').value,
                            qty: qty,
                            amount: qty * price
                        });
                        await saveData();
                        e.target.reset();
                        const totalEl = document.getElementById(type + '-total');
                        if (totalEl) totalEl.textContent = 'Total: Rs 0';
                        renderLists();
                        updateDashboard();
                        renderCalendar();
                    });
                }
            });
            const creditForm = document.getElementById('credit-form');
            if (creditForm) {
                creditForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const file = document.getElementById('credit-photo').files[0];
                    let photo = null;
                    if (file) {
                        photo = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                    }
                    creditEntries.push({
                        date: document.getElementById('credit-date').value,
                        name: document.getElementById('credit-name').value.trim(),
                        contact: document.getElementById('credit-contact').value.trim(),
                        category: document.getElementById('credit-category').value,
                        mode: document.getElementById('credit-mode').value,
                        photo: photo,
                        remarks: document.getElementById('credit-remarks').value.trim(),
                        amount: parseFloat(document.getElementById('credit-amount').value)
                    });
                    await saveData();
                    e.target.reset();
                    document.getElementById('credit-photo-preview').innerHTML = '';
                    renderCreditList();
                    updateDashboard();
                });
            }
            const papadForm = document.getElementById('papad-form');
            if (papadForm) {
                papadForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const file = document.getElementById('papad-photo').files[0];
                    let photo = null;
                    if (file) {
                        photo = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(file);
                        });
                    }
                    papadEntries.push({
                        date: document.getElementById('papad-date').value,
                        category: document.getElementById('papad-category').value,
                        mode: document.getElementById('papad-mode').value,
                        photo: photo,
                        remarks: document.getElementById('papad-remarks').value.trim(),
                        amount: parseFloat(document.getElementById('papad-amount').value)
                    });
                    await saveData();
                    e.target.reset();
                    document.getElementById('papad-photo-preview').innerHTML = '';
                    renderPapadList();
                    updateDashboard();
                });
            }
            function getFilteredEntries(month, year, entries) {
                const isAllMonth = month === 'all';
                const isAllYear = year === 'all';
                const filter = e => {
                    const d = new Date(e.date);
                    return (isAllMonth || d.getMonth() === parseInt(month)) && (isAllYear || d.getFullYear() === parseInt(year));
                };
                return entries.filter(filter);
            }
            function updateDashboard() {
                const month = document.getElementById('dashboard-month').value;
                const year = document.getElementById('dashboard-year').value;
                const milk = getFilteredEntries(month, year, milkEntries);
                const water = getFilteredEntries(month, year, waterEntries);
                const extra = getFilteredEntries(month, year, extraEntries);
                const papad = getFilteredEntries(month, year, papadEntries);
                const credit = getFilteredEntries(month, year, creditEntries);
                const milkLtr = milk.reduce((s, e) => s + e.qty, 0);
                const milkAmt = milk.reduce((s, e) => s + e.amount, 0);
                const waterBtl = water.reduce((s, e) => s + e.qty, 0);
                const waterAmt = water.reduce((s, e) => s + e.amount, 0);
                const extraAmt = extra.reduce((s, e) => s + e.amount, 0);
                const papadAmt = papad.reduce((s, e) => s + e.amount, 0);
                const creditAmt = credit.reduce((s, e) => s + e.amount, 0);
                document.getElementById('dash-milk-ltr').textContent = milkLtr.toFixed(1);
                document.getElementById('dash-milk-amt').textContent = `Rs ${milkAmt.toFixed(2)}`;
                document.getElementById('dash-water-btl').textContent = waterBtl;
                document.getElementById('dash-water-amt').textContent = `Rs ${waterAmt.toFixed(2)}`;
                document.getElementById('dash-extra-amt').textContent = `Rs ${extraAmt.toFixed(2)}`;
                document.getElementById('dash-papad-amt').textContent = `Rs ${papadAmt.toFixed(2)}`;
                document.getElementById('dash-credit-amt').textContent = `Rs ${creditAmt.toFixed(2)}`;
                document.getElementById('dash-total').textContent = `Rs ${(milkAmt + waterAmt + extraAmt + papadAmt - creditAmt).toFixed(2)}`;
                if (monthlyChart) monthlyChart.destroy();
                monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Milk', 'Water', 'Extra', 'Papad', 'Credit'],
                        datasets: [{
                            label: 'Amount (Rs)',
                            data: [milkAmt, waterAmt, extraAmt, papadAmt, creditAmt],
                            backgroundColor: ['#3498db', '#e74c3c', '#9b59b6', '#f39c12', '#27ae60']
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
            function generateMilkPDF() {
                const month = document.getElementById('dashboard-month').value;
                const year = document.getElementById('dashboard-year').value;
                const milk = getFilteredEntries(month, year, milkEntries);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Milk Report', 105, 20, { align: 'center' });
                const body = milk.map(e => [e.date, e.qty.toFixed(1) + ' Ltr', 'Rs ' + e.amount.toFixed(2)]);
                doc.autoTable({ head: [['Date', 'Quantity', 'Amount']], body, startY: 30, theme: 'grid' });
                doc.text(`Total: Rs ${milk.reduce((s, e) => s + e.amount, 0).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
                doc.save('Milk_Report.pdf');
            }
            function generateWaterPDF() {
                const month = document.getElementById('dashboard-month').value;
                const year = document.getElementById('dashboard-year').value;
                const water = getFilteredEntries(month, year, waterEntries);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Water Report', 105, 20, { align: 'center' });
                const body = water.map(e => [e.date, e.qty + ' Btl', 'Rs ' + e.amount.toFixed(2)]);
                doc.autoTable({ head: [['Date', 'Quantity', 'Amount']], body, startY: 30, theme: 'grid' });
                doc.text(`Total: Rs ${water.reduce((s, e) => s + e.amount, 0).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
                doc.save('Water_Report.pdf');
            }
            function generateExtraPDF() {
                const month = document.getElementById('dashboard-month').value;
                const year = document.getElementById('dashboard-year').value;
                const extra = getFilteredEntries(month, year, extraEntries);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                doc.text('Extra Expenses Report', 148, 20, { align: 'center' });
                const body = extra.map(e => [
                    e.date,
                    e.category,
                    e.description,
                    'Rs ' + e.amount.toFixed(2),
                    e.photos && e.photos.length > 0 ? `${e.photos.length} photo(s) attached` : 'No photo'
                ]);
                doc.autoTable({
                    head: [['Date', 'Category', 'Description', 'Amount', 'Photos Info']],
                    body: body,
                    startY: 30,
                    theme: 'grid',
                    columnStyles: { 4: { cellWidth: 80 } }
                });
                const total = extra.reduce((s, e) => s + e.amount, 0);
                doc.text(`Grand Total: Rs ${total.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
                doc.save('Extra_Report.pdf');
            }
            function generatePapadPDF() {
                const month = document.getElementById('dashboard-month').value;
                const year = document.getElementById('dashboard-year').value;
                const papad = getFilteredEntries(month, year, papadEntries);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                doc.text('Papad Expenses Report', 148, 20, { align: 'center' });
                const body = papad.map(e => [
                    e.date, e.category, e.mode, 'Rs ' + e.amount.toFixed(2),
                    e.photo ? 'Photo attached' : 'No photo', e.remarks || '-'
                ]);
                doc.autoTable({
                    head: [['Date', 'Category', 'Mode', 'Amount', 'Photo', 'Remarks']],
                    body, startY: 30, theme: 'grid'
                });
                const total = papad.reduce((s, e) => s + e.amount, 0);
                doc.text(`Total: Rs ${total.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
                doc.save('Papad_Report.pdf');
            }
            function renderCalendar() {
                const monthVal = document.getElementById('cal-month').value;
                const yearVal = document.getElementById('cal-year').value;
                const month = monthVal === 'all' ? null : parseInt(monthVal);
                const year = yearVal === 'all' ? null : parseInt(yearVal);
                const container = document.getElementById('calendar-container');
                if (!container) return;
                container.innerHTML = '';
                const allEntries = [...milkEntries.map(e => ({ ...e, type: 'milk' })), ...waterEntries.map(e => ({ ...e, type: 'water' }))];
                const filtered = allEntries.filter(e => {
                    const d = new Date(e.date);
                    return (month === null || d.getMonth() === month) && (year === null || d.getFullYear() === year);
                });
                if (filtered.length === 0) {
                    container.innerHTML = '<p>No entries in selected period.</p>';
                    return;
                }
                const grouped = {};
                filtered.forEach(e => {
                    const d = new Date(e.date);
                    const key = `${d.getFullYear()}-${d.getMonth()}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(e);
                });
                Object.keys(grouped).sort((a, b) => b.localeCompare(a)).forEach(key => {
                    const [y, m] = key.split('-').map(Number);
                    const monthEntries = grouped[key];
                    const monthDiv = document.createElement('div');
                    monthDiv.style.marginBottom = '40px';
                    const title = document.createElement('h3');
                    title.textContent = new Date(y, m).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long', year: 'numeric' });
                    monthDiv.appendChild(title);
                    const header = document.createElement('div');
                    header.className = 'calendar-header';
                    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                        const div = document.createElement('div');
                        div.textContent = day;
                        header.appendChild(div);
                    });
                    monthDiv.appendChild(header);
                    const grid = document.createElement('div');
                    grid.className = 'calendar-grid';
                    const firstDay = new Date(y, m, 1).getDay();
                    const daysInMonth = new Date(y, m + 1, 0).getDate();
                    const dayMap = {};
                    monthEntries.forEach(e => {
                        const day = new Date(e.date).getDate();
                        if (!dayMap[day]) dayMap[day] = { milk: 0, water: 0, total: 0 };
                        if (e.type === 'milk') dayMap[day].milk += e.qty;
                        else dayMap[day].water += e.qty;
                        dayMap[day].total += e.amount;
                    });
                    for (let i = 0; i < firstDay; i++) {
                        const empty = document.createElement('div');
                        grid.appendChild(empty);
                    }
                    for (let day = 1; day <= daysInMonth; day++) {
                        const cell = document.createElement('div');
                        cell.className = 'calendar-day';
                        if (dayMap[day]) cell.classList.add('has-entry');
                        cell.innerHTML = `<div class="day-number">${day}</div>`;
                        if (dayMap[day]) {
                            const entriesDiv = document.createElement('div');
                            entriesDiv.className = 'day-entries';
                            if (dayMap[day].milk > 0) entriesDiv.innerHTML += `Milk: ${dayMap[day].milk.toFixed(1)}L<br>`;
                            if (dayMap[day].water > 0) entriesDiv.innerHTML += `Water: ${dayMap[day].water}B<br>`;
                            entriesDiv.innerHTML += `Rs ${dayMap[day].total.toFixed(2)}`;
                            cell.appendChild(entriesDiv);
                        }
                        grid.appendChild(cell);
                    }
                    monthDiv.appendChild(grid);
                    container.appendChild(monthDiv);
                });
            }
            function renderGroupedList(containerId, entries, type) {
                let globalEntries;
                if (type === 'milk') {
                    globalEntries = milkEntries;
                } else if (type === 'water') {
                    globalEntries = waterEntries;
                } else {
                    return;
                }
                const cont = document.getElementById(containerId);
                if (!cont) return;
                cont.innerHTML = entries.length === 0 ? '<div class="no-data">No entries</div>' : '';
                if (entries.length === 0) return;
                let currentMonth = '';
                let currentTable = null;
                entries.sort((a, b) => a.date.localeCompare(b.date)).forEach((e, idx) => {
                    const entryMonth = new Date(e.date).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long', year: 'numeric' });
                    if (entryMonth !== currentMonth) {
                        currentMonth = entryMonth;
                        const separator = document.createElement('div');
                        separator.className = 'month-separator';
                        separator.textContent = currentMonth;
                        cont.appendChild(separator);
                        currentTable = document.createElement('table');
                        currentTable.innerHTML = `<thead><tr><th>Date</th><th>Quantity</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody>`;
                        cont.appendChild(currentTable);
                    }
                    const tbody = currentTable.querySelector('tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${e.date}</td><td>${type === 'milk' ? e.qty.toFixed(1) : e.qty} ${type === 'milk' ? 'Ltr' : 'Btl'}</td><td class="amount">Rs ${e.amount.toFixed(2)}</td><td class="actions"></td>`;
                    const actions = row.querySelector('.actions');
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'Edit';
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Delete';
                    actions.append(editBtn, delBtn);
                    editBtn.onclick = () => {
                        const dateCell = row.cells[0];
                        const qtyCell = row.cells[1];
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.value = e.date;
                        dateCell.innerHTML = '';
                        dateCell.appendChild(dateInput);
                        const qtyInput = document.createElement('input');
                        qtyInput.type = 'number';
                        qtyInput.value = e.qty;
                        qtyInput.step = type === 'milk' ? '0.5' : '1';
                        qtyCell.innerHTML = '';
                        qtyCell.appendChild(qtyInput);
                        editBtn.textContent = 'Save';
                        editBtn.className = 'save-btn';
                        editBtn.onclick = async () => {
                            const newDate = dateInput.value;
                            const newQty = parseFloat(qtyInput.value);
                            if (newDate && !isNaN(newQty) && newQty >= 0) {
                                entries[idx].date = newDate;
                                entries[idx].qty = newQty;
                                entries[idx].amount = newQty * (type === 'milk' ? MILK_PRICE : WATER_PRICE);
                                await saveData();
                                renderLists();
                                updateDashboard();
                                renderCalendar();
                            }
                        };
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => renderLists();
                        actions.insertBefore(cancelBtn, delBtn);
                        delBtn.style.display = 'none';
                    };
                    delBtn.onclick = async () => {
                        if (confirm('Delete this entry?')) {
                            const actualIdx = globalEntries.indexOf(e);
                            if (actualIdx !== -1) {
                                globalEntries.splice(actualIdx, 1);
                            }
                            await saveData();
                            renderLists();
                            updateDashboard();
                            renderCalendar();
                        }
                    };
                    tbody.appendChild(row);
                });
            }
            function renderExtraList(containerId = 'extra-list', entries = extraEntries, month = 'all', year = 'all') {
                const filtered = getFilteredEntries(month, year, entries).sort((a, b) => a.date.localeCompare(b.date));
                const cont = document.getElementById(containerId);
                if (!cont) return;
                cont.innerHTML = filtered.length === 0 ? '<div class="no-data">No extra expenses</div>' : '';
                if (filtered.length === 0) {
                    document.getElementById(containerId === 'extra-list' ? 'extra-total' : '').style.display = 'none';
                    return;
                }
                let currentMonth = '';
                let currentTable = null;
                let total = 0;
                filtered.forEach((e, fIdx) => {
                    const actualIdx = entries.indexOf(e);
                    const entryMonth = new Date(e.date).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long', year: 'numeric' });
                    if (entryMonth !== currentMonth) {
                        currentMonth = entryMonth;
                        const separator = document.createElement('div');
                        separator.className = 'month-separator';
                        separator.textContent = currentMonth;
                        cont.appendChild(separator);
                        currentTable = document.createElement('table');
                        currentTable.innerHTML = `<thead><tr><th>Date</th><th>Category</th><th>Description</th><th class="amount">Amount</th><th>Photos</th><th class="actions">Actions</th></tr></thead><tbody></tbody>`;
                        cont.appendChild(currentTable);
                    }
                    total += e.amount;
                    const tbody = currentTable.querySelector('tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.category}</td>
                    <td>${e.description}</td>
                    <td class="amount">Rs ${e.amount.toFixed(2)}</td>
                    <td class="photo-gallery"></td>
                    <td class="actions"></td>
                `;
                    const photoCell = row.cells[4];
                    if (e.photos && e.photos.length > 0) {
                        e.photos.forEach((photo, i) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'photo-wrapper';
                            const img = document.createElement('img');
                            img.src = photo;
                            img.className = 'photo-preview';
                            img.onclick = () => {
                                document.getElementById('modal-photo').src = photo;
                                document.getElementById('photo-modal').style.display = 'flex';
                            };
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-photo-btn';
                            downloadBtn.textContent = 'Download';
                            downloadBtn.onclick = (ev) => {
                                ev.stopPropagation();
                                const a = document.createElement('a');
                                a.href = photo;
                                a.download = `extra_photo_${e.date}_${i + 1}.jpg`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            };
                            wrapper.appendChild(img);
                            wrapper.appendChild(downloadBtn);
                            photoCell.appendChild(wrapper);
                        });
                    } else {
                        photoCell.textContent = '-';
                    }
                    const actions = row.cells[5];
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'Edit';
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Delete';
                    actions.append(editBtn, delBtn);
                    editBtn.onclick = () => {
                        const cells = row.cells;
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.value = e.date;
                        cells[0].innerHTML = '';
                        cells[0].appendChild(dateInput);
                        const catSelect = document.createElement('select');
                        ['Utensils', 'Repairs', 'Electricity Bill', 'Mobile Bill', 'Gas Bill', 'Event', 'Grocery', 'Other'].forEach(c => {
                            const o = document.createElement('option');
                            o.value = c;
                            o.textContent = c;
                            if (c === e.category) o.selected = true;
                            catSelect.appendChild(o);
                        });
                        cells[1].innerHTML = '';
                        cells[1].appendChild(catSelect);
                        const descInput = document.createElement('input');
                        descInput.type = 'text';
                        descInput.value = e.description;
                        cells[2].innerHTML = '';
                        cells[2].appendChild(descInput);
                        const amtInput = document.createElement('input');
                        amtInput.type = 'number';
                        amtInput.step = '0.01';
                        amtInput.value = e.amount;
                        cells[3].innerHTML = '';
                        cells[3].appendChild(amtInput);
                        photoCell.innerHTML = '<input type="file" multiple accept="image/*"><div class="photo-gallery"></div>';
                        const newFileInput = photoCell.querySelector('input');
                        const gallery = photoCell.querySelector('.photo-gallery');
                        (e.photos || []).forEach((photo, i) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'photo-wrapper';
                            const img = document.createElement('img');
                            img.src = photo;
                            img.className = 'photo-preview';
                            img.onclick = () => {
                                document.getElementById('modal-photo').src = photo;
                                document.getElementById('photo-modal').style.display = 'flex';
                            };
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'download-photo-btn';
                            downloadBtn.textContent = 'Download';
                            downloadBtn.onclick = (ev) => {
                                ev.stopPropagation();
                                const a = document.createElement('a');
                                a.href = photo;
                                a.download = `extra_photo_${e.date}_${i + 1}.jpg`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            };
                            wrapper.appendChild(img);
                            wrapper.appendChild(downloadBtn);
                            gallery.appendChild(wrapper);
                        });
                        newFileInput.addEventListener('change', () => {
                            Array.from(newFileInput.files).forEach(file => {
                                const reader = new FileReader();
                                reader.onload = ev => {
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'photo-wrapper';
                                    const img = document.createElement('img');
                                    img.src = ev.target.result;
                                    img.className = 'photo-preview';
                                    img.onclick = () => {
                                        document.getElementById('modal-photo').src = ev.target.result;
                                        document.getElementById('photo-modal').style.display = 'flex';
                                    };
                                    const downloadBtn = document.createElement('button');
                                    downloadBtn.className = 'download-photo-btn';
                                    downloadBtn.textContent = 'Download';
                                    downloadBtn.onclick = (ev) => {
                                        ev.stopPropagation();
                                        const a = document.createElement('a');
                                        a.href = ev.target.result;
                                        a.download = `extra_photo_${e.date}_${i + 1}.jpg`;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                    };
                                    wrapper.appendChild(img);
                                    wrapper.appendChild(downloadBtn);
                                    gallery.appendChild(wrapper);
                                };
                                reader.readAsDataURL(file);
                            });
                        });
                        editBtn.textContent = 'Save';
                        editBtn.className = 'save-btn';
                        editBtn.onclick = async () => {
                            const finalPhotos = [];
                            gallery.querySelectorAll('.photo-preview').forEach(img => finalPhotos.push(img.src));
                            entries[actualIdx] = {
                                date: dateInput.value,
                                category: catSelect.value,
                                description: descInput.value.trim(),
                                amount: parseFloat(amtInput.value),
                                photos: finalPhotos
                            };
                            await saveData();
                            renderExtraList(containerId, entries, month, year);
                            updateDashboard();
                        };
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => renderExtraList(containerId, entries, month, year);
                        actions.insertBefore(cancelBtn, delBtn);
                        delBtn.style.display = 'none';
                    };
                    delBtn.onclick = async () => {
                        if (confirm('Delete this extra expense?')) {
                            entries.splice(actualIdx, 1);
                            await saveData();
                            renderExtraList(containerId, entries, month, year);
                            updateDashboard();
                        }
                    };
                    tbody.appendChild(row);
                });
                if (containerId === 'extra-list') {
                    document.getElementById('extra-total').textContent = `Total Extra: Rs ${total.toFixed(2)}`;
                    document.getElementById('extra-total').style.display = 'block';
                }
            }
            function renderCreditList(containerId = 'credit-list', entries = creditEntries) {
                const month = document.getElementById('credit-month') ? document.getElementById('credit-month').value : 'all';
                const year = document.getElementById('credit-year') ? document.getElementById('credit-year').value : 'all';
                const category = document.getElementById('credit-filter-category') ? document.getElementById('credit-filter-category').value : 'all';
                let filtered = getFilteredEntries(month, year, entries);
                if (category !== 'all') filtered = filtered.filter(e => e.category === category);
                filtered = filtered.sort((a, b) => a.date.localeCompare(b.date));
                const cont = document.getElementById(containerId);
                if (!cont) return;
                cont.innerHTML = filtered.length === 0 ? '<div class="no-data">No credit entries</div>' : '';
                if (filtered.length === 0) {
                    document.getElementById(containerId === 'credit-list' ? 'credit-total' : '').style.display = 'none';
                    return;
                }
                let currentMonth = '';
                let currentTable = null;
                let total = 0;
                filtered.forEach((e, fIdx) => {
                    const actualIdx = entries.indexOf(e);
                    const entryMonth = new Date(e.date).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long', year: 'numeric' });
                    if (entryMonth !== currentMonth) {
                        currentMonth = entryMonth;
                        const separator = document.createElement('div');
                        separator.className = 'month-separator';
                        separator.textContent = currentMonth;
                        cont.appendChild(separator);
                        currentTable = document.createElement('table');
                        currentTable.innerHTML = `<thead><tr><th>Date</th><th>Name</th><th>Contact</th><th>Category</th><th>Mode</th><th>Amount</th><th>Photo</th><th>Remarks</th><th>Actions</th></tr></thead><tbody></tbody>`;
                        cont.appendChild(currentTable);
                    }
                    total += e.amount;
                    const tbody = currentTable.querySelector('tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.name}</td>
                    <td>${e.contact}</td>
                    <td>${e.category}</td>
                    <td>${e.mode}</td>
                    <td class="amount">Rs ${e.amount.toFixed(2)}</td>
                    <td class="photo-gallery"></td>
                    <td>${e.remarks || '-'}</td>
                    <td class="actions"></td>
                `;
                    const photoCell = row.cells[6];
                    if (e.photo) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'photo-wrapper';
                        const img = document.createElement('img');
                        img.src = e.photo;
                        img.className = 'photo-preview';
                        img.onclick = () => {
                            document.getElementById('modal-photo').src = e.photo;
                            document.getElementById('photo-modal').style.display = 'flex';
                        };
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-photo-btn';
                        downloadBtn.textContent = 'Download';
                        downloadBtn.onclick = (ev) => {
                            ev.stopPropagation();
                            const a = document.createElement('a');
                            a.href = e.photo;
                            a.download = `credit_photo_${e.date}.jpg`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        };
                        wrapper.appendChild(img);
                        wrapper.appendChild(downloadBtn);
                        photoCell.appendChild(wrapper);
                    } else {
                        photoCell.textContent = '-';
                    }
                    const actions = row.cells[8];
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'Edit';
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Delete';
                    actions.append(editBtn, delBtn);
                    editBtn.onclick = () => {
                        const cells = row.cells;
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.value = e.date;
                        cells[0].innerHTML = '';
                        cells[0].appendChild(dateInput);
                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.value = e.name;
                        cells[1].innerHTML = '';
                        cells[1].appendChild(nameInput);
                        const contactInput = document.createElement('input');
                        contactInput.type = 'tel';
                        contactInput.value = e.contact;
                        cells[2].innerHTML = '';
                        cells[2].appendChild(contactInput);
                        const catSelect = document.createElement('select');
                        ['client', 'salary', 'business', 'others'].forEach(c => {
                            const o = document.createElement('option');
                            o.value = c;
                            o.textContent = c.charAt(0).toUpperCase() + c.slice(1);
                            if (c === e.category) o.selected = true;
                            catSelect.appendChild(o);
                        });
                        cells[3].innerHTML = '';
                        cells[3].appendChild(catSelect);
                        const modeSelect = document.createElement('select');
                        ['cash', 'G-Pay', 'online', 'BT', 'other'].forEach(m => {
                            const o = document.createElement('option');
                            o.value = m;
                            o.textContent = m;
                            if (m === e.mode) o.selected = true;
                            modeSelect.appendChild(o);
                        });
                        cells[4].innerHTML = '';
                        cells[4].appendChild(modeSelect);
                        const amtInput = document.createElement('input');
                        amtInput.type = 'number';
                        amtInput.step = '0.01';
                        amtInput.value = e.amount;
                        cells[5].innerHTML = '';
                        cells[5].appendChild(amtInput);
                        photoCell.innerHTML = '<input type="file" accept="image/*"><div class="photo-gallery"></div>';
                        const newFileInput = photoCell.querySelector('input');
                        const gallery = photoCell.querySelector('.photo-gallery');
                        if (e.photo) {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'photo-wrapper';
                            const img = document.createElement('img');
                            img.src = e.photo;
                            img.className = 'photo-preview';
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-photo-btn';
                            removeBtn.textContent = 'Remove';
                            removeBtn.onclick = (ev) => {
                                ev.stopPropagation();
                                wrapper.remove();
                            };
                            wrapper.append(img, removeBtn);
                            gallery.appendChild(wrapper);
                        }
                        newFileInput.addEventListener('change', () => {
                            const file = newFileInput.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = ev => {
                                    gallery.innerHTML = '';
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'photo-wrapper';
                                    const img = document.createElement('img');
                                    img.src = ev.target.result;
                                    img.className = 'photo-preview';
                                    const removeBtn = document.createElement('button');
                                    removeBtn.className = 'remove-photo-btn';
                                    removeBtn.textContent = 'Remove';
                                    removeBtn.onclick = (ev) => {
                                        ev.stopPropagation();
                                        wrapper.remove();
                                    };
                                    wrapper.append(img, removeBtn);
                                    gallery.appendChild(wrapper);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                        const remarksInput = document.createElement('input');
                        remarksInput.type = 'text';
                        remarksInput.value = e.remarks || '';
                        cells[7].innerHTML = '';
                        cells[7].appendChild(remarksInput);
                        editBtn.textContent = 'Save';
                        editBtn.className = 'save-btn';
                        editBtn.onclick = async () => {
                            let finalPhoto = null;
                            const galleryImg = gallery.querySelector('img');
                            if (galleryImg) finalPhoto = galleryImg.src;
                            entries[actualIdx] = {
                                date: dateInput.value,
                                name: nameInput.value.trim(),
                                contact: contactInput.value.trim(),
                                category: catSelect.value,
                                mode: modeSelect.value,
                                photo: finalPhoto,
                                remarks: remarksInput.value.trim(),
                                amount: parseFloat(amtInput.value)
                            };
                            await saveData();
                            renderCreditList(containerId);
                            updateDashboard();
                        };
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => renderCreditList(containerId);
                        actions.insertBefore(cancelBtn, delBtn);
                        delBtn.style.display = 'none';
                    };
                    delBtn.onclick = async () => {
                        if (confirm('Delete this credit entry?')) {
                            entries.splice(actualIdx, 1);
                            await saveData();
                            renderCreditList(containerId);
                            updateDashboard();
                        }
                    };
                    tbody.appendChild(row);
                });
                if (containerId === 'credit-list') {
                    document.getElementById('credit-total').textContent = `Total Credit: Rs ${total.toFixed(2)}`;
                    document.getElementById('credit-total').style.display = 'block';
                }
            }
            function renderPapadList(containerId = 'papad-list', entries = papadEntries) {
                const month = document.getElementById('papad-month') ? document.getElementById('papad-month').value : 'all';
                const year = document.getElementById('papad-year') ? document.getElementById('papad-year').value : 'all';
                const filtered = getFilteredEntries(month, year, entries).sort((a, b) => a.date.localeCompare(b.date));
                const cont = document.getElementById(containerId);
                if (!cont) return;
                cont.innerHTML = filtered.length === 0 ? '<div class="no-data">No papad expenses</div>' : '';
                if (filtered.length === 0) {
                    document.getElementById(containerId === 'papad-list' ? 'papad-total' : '').style.display = 'none';
                    return;
                }
                let currentMonth = '';
                let currentTable = null;
                let total = 0;
                filtered.forEach((e, fIdx) => {
                    const actualIdx = entries.indexOf(e);
                    const entryMonth = new Date(e.date).toLocaleString(currentLang === 'en' ? 'default' : currentLang, { month: 'long', year: 'numeric' });
                    if (entryMonth !== currentMonth) {
                        currentMonth = entryMonth;
                        const separator = document.createElement('div');
                        separator.className = 'month-separator';
                        separator.textContent = currentMonth;
                        cont.appendChild(separator);
                        currentTable = document.createElement('table');
                        currentTable.innerHTML = `<thead><tr><th>Date</th><th>Category</th><th>Mode</th><th>Amount</th><th>Photo</th><th>Remarks</th><th>Actions</th></tr></thead><tbody></tbody>`;
                        cont.appendChild(currentTable);
                    }
                    total += e.amount;
                    const tbody = currentTable.querySelector('tbody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.category}</td>
                    <td>${e.mode}</td>
                    <td class="amount">Rs ${e.amount.toFixed(2)}</td>
                    <td class="photo-gallery"></td>
                    <td>${e.remarks || '-'}</td>
                    <td class="actions"></td>
                `;
                    const photoCell = row.cells[4];
                    if (e.photo) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'photo-wrapper';
                        const img = document.createElement('img');
                        img.src = e.photo;
                        img.className = 'photo-preview';
                        img.onclick = () => {
                            document.getElementById('modal-photo').src = e.photo;
                            document.getElementById('photo-modal').style.display = 'flex';
                        };
                        const downloadBtn = document.createElement('button');
                        downloadBtn.className = 'download-photo-btn';
                        downloadBtn.textContent = 'Download';
                        downloadBtn.onclick = (ev) => {
                            ev.stopPropagation();
                            const a = document.createElement('a');
                            a.href = e.photo;
                            a.download = `papad_photo_${e.date}.jpg`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        };
                        wrapper.appendChild(img);
                        wrapper.appendChild(downloadBtn);
                        photoCell.appendChild(wrapper);
                    } else {
                        photoCell.textContent = '-';
                    }
                    const actions = row.cells[6];
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.textContent = 'Edit';
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Delete';
                    actions.append(editBtn, delBtn);
                    editBtn.onclick = () => {
                        const cells = row.cells;
                        const dateInput = document.createElement('input');
                        dateInput.type = 'date';
                        dateInput.value = e.date;
                        cells[0].innerHTML = '';
                        cells[0].appendChild(dateInput);
                        const catSelect = document.createElement('select');
                        ['Utensils', 'Groceries', 'Event', 'Bills', 'Medicine', 'others'].forEach(c => {
                            const o = document.createElement('option');
                            o.value = c;
                            o.textContent = c;
                            if (c === e.category) o.selected = true;
                            catSelect.appendChild(o);
                        });
                        cells[1].innerHTML = '';
                        cells[1].appendChild(catSelect);
                        const modeSelect = document.createElement('select');
                        ['cash', 'G-Pay', 'online', 'BT', 'other'].forEach(m => {
                            const o = document.createElement('option');
                            o.value = m;
                            o.textContent = m;
                            if (m === e.mode) o.selected = true;
                            modeSelect.appendChild(o);
                        });
                        cells[2].innerHTML = '';
                        cells[2].appendChild(modeSelect);
                        const amtInput = document.createElement('input');
                        amtInput.type = 'number';
                        amtInput.step = '0.01';
                        amtInput.value = e.amount;
                        cells[3].innerHTML = '';
                        cells[3].appendChild(amtInput);
                        photoCell.innerHTML = '<input type="file" accept="image/*"><div class="photo-gallery"></div>';
                        const newFileInput = photoCell.querySelector('input');
                        const gallery = photoCell.querySelector('.photo-gallery');
                        if (e.photo) {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'photo-wrapper';
                            const img = document.createElement('img');
                            img.src = e.photo;
                            img.className = 'photo-preview';
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-photo-btn';
                            removeBtn.textContent = 'Remove';
                            removeBtn.onclick = (ev) => {
                                ev.stopPropagation();
                                wrapper.remove();
                            };
                            wrapper.append(img, removeBtn);
                            gallery.appendChild(wrapper);
                        }
                        newFileInput.addEventListener('change', () => {
                            const file = newFileInput.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = ev => {
                                    gallery.innerHTML = '';
                                    const wrapper = document.createElement('div');
                                    wrapper.className = 'photo-wrapper';
                                    const img = document.createElement('img');
                                    img.src = ev.target.result;
                                    img.className = 'photo-preview';
                                    const removeBtn = document.createElement('button');
                                    removeBtn.className = 'remove-photo-btn';
                                    removeBtn.textContent = 'Remove';
                                    removeBtn.onclick = (ev) => {
                                        ev.stopPropagation();
                                        wrapper.remove();
                                    };
                                    wrapper.append(img, removeBtn);
                                    gallery.appendChild(wrapper);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                        const remarksInput = document.createElement('input');
                        remarksInput.type = 'text';
                        remarksInput.value = e.remarks || '';
                        cells[5].innerHTML = '';
                        cells[5].appendChild(remarksInput);
                        editBtn.textContent = 'Save';
                        editBtn.className = 'save-btn';
                        editBtn.onclick = async () => {
                            let finalPhoto = null;
                            const galleryImg = gallery.querySelector('img');
                            if (galleryImg) finalPhoto = galleryImg.src;
                            entries[actualIdx] = {
                                date: dateInput.value,
                                category: catSelect.value,
                                mode: modeSelect.value,
                                photo: finalPhoto,
                                remarks: remarksInput.value.trim(),
                                amount: parseFloat(amtInput.value)
                            };
                            await saveData();
                            renderPapadList(containerId);
                            updateDashboard();
                        };
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'cancel-btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => renderPapadList(containerId);
                        actions.insertBefore(cancelBtn, delBtn);
                        delBtn.style.display = 'none';
                    };
                    delBtn.onclick = async () => {
                        if (confirm('Delete this papad expense?')) {
                            entries.splice(actualIdx, 1);
                            await saveData();
                            renderPapadList(containerId);
                            updateDashboard();
                        }
                    };
                    tbody.appendChild(row);
                });
                if (containerId === 'papad-list') {
                    document.getElementById('papad-total').textContent = `Total Papad: Rs ${total.toFixed(2)}`;
                    document.getElementById('papad-total').style.display = 'block';
                }
            }
            function renderLists() {
                const month = document.getElementById('list-month').value;
                const year = document.getElementById('list-year').value;
                const milk = getFilteredEntries(month, year, milkEntries);
                const water = getFilteredEntries(month, year, waterEntries);
                const extra = getFilteredEntries(month, year, extraEntries);
                const credit = getFilteredEntries(month, year, creditEntries);
                const papad = getFilteredEntries(month, year, papadEntries);
                renderGroupedList('milk-list', milk, 'milk');
                renderGroupedList('water-list', water, 'water');
                renderExtraList('extra-list', extraEntries, month, year);
                renderCreditList('credit-list-short', creditEntries);
                renderPapadList('papad-list-short', papadEntries);
                const grandTotal = milk.reduce((s, e) => s + e.amount, 0) + water.reduce((s, e) => s + e.amount, 0) +
                    extra.reduce((s, e) => s + e.amount, 0) + papad.reduce((s, e) => s + e.amount, 0) - credit.reduce((s, e) => s + e.amount, 0);
                const grandDiv = document.getElementById('list-grand-total');
                if (grandDiv) {
                    if (grandTotal !== 0) {
                        grandDiv.textContent = `Grand Total: Rs ${grandTotal.toFixed(2)}`;
                        grandDiv.style.display = 'block';
                    } else {
                        grandDiv.style.display = 'none';
                    }
                }
            }
            function toggleTheme() {
                document.body.classList.toggle('dark-mode');
            }
            function openTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                const tab = document.getElementById(tabName);
                if (tab) tab.style.display = 'block';
                const btn = document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`);
                if (btn) btn.classList.add('active');
                if (tabName === 'dashboard') updateDashboard();
                if (tabName === 'calendar') renderCalendar();
                if (tabName === 'lists') renderLists();
                if (tabName === 'credit') renderCreditList();
                if (tabName === 'papad') renderPapadList();
            }
            // Photo modal close on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('photo-modal').style.display = 'none';
                    document.getElementById('edit-profile-modal').style.display = 'none';
                }
            });
                        // Initialize credit and papad preview listeners
            const creditPhotoInput = document.getElementById('credit-photo');
            if (creditPhotoInput) {
                creditPhotoInput.addEventListener('change', e => {
                    const file = e.target.files[0];
                    const preview = document.getElementById('credit-photo-preview');
                    preview.innerHTML = '';
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            const img = document.createElement('img');
                            img.src = ev.target.result;
                            img.className = 'photo-preview';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            const papadPhotoInput = document.getElementById('papad-photo');
            if (papadPhotoInput) {
                papadPhotoInput.addEventListener('change', e => {
                    const file = e.target.files[0];
                    const preview = document.getElementById('papad-photo-preview');
                    preview.innerHTML = '';
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            const img = document.createElement('img');
                            img.src = ev.target.result;
                            img.className = 'photo-preview';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        </script>
    </body>
</html>
