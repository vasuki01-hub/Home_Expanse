<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Expanses</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #f4f6f9;
            --container-bg: white;
            --text: #333;
            --heading: #2c3e50;
            --border: #ddd;
            --stat-bg: #ecf0f1;
            --table-header: #f1f1f1;
            --input-border: #ccc;
            --no-data: #777;
            --shadow: rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --bg: #121212;
            --container-bg: #1e1e1e;
            --text: #e0e0e0;
            --heading: #f1f1f1;
            --border: #444;
            --stat-bg: #2d2d2d;
            --table-header: #333;
            --input-border: #555;
            --no-data: #999;
            --shadow: rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 0 15px var(--shadow);
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 { color: var(--heading); margin-bottom: 10px; }
        .header-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        select, button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background: var(--container-bg);
            color: var(--text);
            font-size: 0.9em;
        }
        button { background: #3498db; color: white; cursor: pointer; }
        button:hover { background: #2980b9; }
        .pdf-btn { background: #e74c3c; }
        .edit-btn { background: #f39c12; font-size: 0.8em; padding: 4px 8px; margin: 2px; }
        .delete-btn { background: #e74c3c; font-size: 0.8em; padding: 4px 8px; margin: 2px; }
        .remove-photo-btn { background: #c0392b; font-size: 0.8em; padding: 3px 6px; margin: 2px; }
        .save-btn { background: #27ae60; }
        .cancel-btn { background: #95a5a6; }
        h2 {
            font-size: medium;
            background: #000000;
            color: white;
            padding: 12px;
            border-radius: 30px;
            margin: 30px 0 20px;
            text-align: center;
        }
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }
        .tab-btn.active { background: #2c3e50; }
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            padding: 20px;
            background: var(--stat-bg);
            border-radius: 8px;
            margin-bottom: 30px;
        }
        input, select {
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            width: 100%;
        }
        .filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 0.9em;
            justify-content: flex-start;
        }
        .filter label { margin-right: 5px; white-space: nowrap; }
        .filter select {
            padding: 5px 8px;
            font-size: 0.9em;
            max-width: 150px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat {
            background: var(--stat-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat h3 { margin-bottom: 10px; }
        .stat p { font-size: 1.8em; font-weight: bold; color: #e74c3c; }
        .chart-container { margin: 30px 0; height: 300px; }
        .no-data { text-align: center; padding: 40px; color: var(--no-data); font-style: italic; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; border: 1px solid var(--border); text-align: left; font-size: 0.9em; }
        th { background: var(--table-header); }
        .amount { text-align: right; }
        .actions { text-align: center; white-space: nowrap; }
        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
        }
        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        .photo-wrapper {
            position: relative;
            display: inline-block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .modal-content {
            max-width: 90%;
            text-align: center;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            cursor: pointer;
            color: white;
        }
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #2c3e50;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        .calendar-header div { padding: 10px; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .calendar-day {
            min-height: 100px;
            background: white
            border  1px solid var(--border);
            padding : 5px;
            font-size : 1rem;
        }
        .calendar-day.other-month { opacity: 0.5; }
        .calendar-day.has-entry { background: none ; }
        .day-number { font-weight: bold; }
        .day-entries { font-size: 0.8em; margin-top: 5px; line-height: 1.3; }
        #login-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #dfe3f3;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: var(--container-bg);
            padding: 40px;
            border-radius: 30px;
            width: 350px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #main-app { display: none; }
        .sync-status {
            text-align: center;
            font-size: 0.9em;
            margin: 10px 0;
            color: #27ae60;
        }
        .logout-btn { background: #e74c3c; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-box">
            <h2 data-lang="login_title">Home Expanses Login</h2>
            <input type="password" id="login-password" placeholder="Enter Password">
            <button id="login-btn" data-lang="login_btn">Login</button>
            <p id="login-error" style="color:red; margin-top:15px; display:none;" data-lang="wrong_password">Incorrect password!</p>
        </div>
    </div>

    <div id="main-app" class="container">
        <header>
            <h1 data-lang="title">Home Expanses</h1>
            <div class="header-controls">
                <select id="language-select" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="hi">हिंदी</option>
                    <option value="gu">ગુજરાતી</option>
                </select>
                <button onclick="toggleTheme()" data-lang="dark_mode">Dark Mode</button>
                <button id="logout-btn" class="logout-btn" style="display:none;">Logout</button>
            </div>
        </header>

        <div class="sync-status" id="sync-status">Loading data...</div>

        <section class="tabs">
            <button class="tab-btn active" onclick="openTab('dashboard')" data-lang="Dashboard">Dashboard</button>
            <button class="tab-btn" onclick="openTab('milk')" data-lang="add_milk">Add Milk</button>
            <button class="tab-btn" onclick="openTab('water')" data-lang="add_water">Add Water</button>
            <button class="tab-btn" onclick="openTab('extra')" data-lang="add_extra">Add Extra Expense</button>
            <button class="tab-btn" onclick="openTab('calendar')" data-lang="calendar_view">Calendar View</button>
            <button class="tab-btn" onclick="openTab('lists')" data-lang="list_view">List View</button>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="tab-content">
            <div class="filter">
                <label data-lang="filter_month">Month:</label>
                <select id="dashboard-month" onchange="updateDashboard()"></select>
                <label data-lang="filter_year">Year:</label>
                <select id="dashboard-year" onchange="updateDashboard()"></select>
                <div style="margin-left: auto;">
                    <button class="pdf-btn" onclick="generateMilkPDF()" data-lang="download_milk_pdf">Milk PDF</button>
                    <button class="pdf-btn" onclick="generateWaterPDF()" data-lang="download_water_pdf">Water PDF</button>
                    <button class="pdf-btn" onclick="generateExtraPDF()" data-lang="download_extra_pdf">Extra PDF</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat"><h3 data-lang="total_milk_ltr">Total Milk (Ltr)</h3><p id="dash-milk-ltr">0</p></div>
                <div class="stat"><h3 data-lang="milk_expense">Milk Expense</h3><p id="dash-milk-amt">₹0</p></div>
                <div class="stat"><h3 data-lang="total_water_btl">Total Water (Btl)</h3><p id="dash-water-btl">0</p></div>
                <div class="stat"><h3 data-lang="water_expense">Water Expense</h3><p id="dash-water-amt">₹0</p></div>
                <div class="stat"><h3 data-lang="extra_expense">Extra Expenses</h3><p id="dash-extra-amt">₹0</p></div>
                <div class="stat"><h3 data-lang="total_expense">Grand Total</h3><p id="dash-total">₹0</p></div>
            </div>

            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </section>

        <!-- Add Forms -->
        <section id="milk" class="tab-content" style="display:none;">
            <h2 data-lang="add_milk">Add Milk Purchase</h2>
            <form id="milk-form">
                <input type="date" id="milk-date" required>
                <input type="number" id="milk-qty" placeholder="Quantity (Liters)" min="0" step="0.5" required>
                <div><strong data-lang="milk_price">Fixed Price: ₹60 per Liter</strong><div class="auto-amount" id="milk-total">Total: ₹0</div></div>
                <button type="submit" data-lang="add_milk_btn">Add Milk Entry</button>
            </form>
        </section>

        <section id="water" class="tab-content" style="display:none;">
            <h2 data-lang="add_water">Add Water Purchase</h2>
            <form id="water-form">
                <input type="date" id="water-date" required>
                <input type="number" id="water-qty" placeholder="Quantity (Bottles)" min="1" step="1" required>
                <div><strong data-lang="water_price">Fixed Price: ₹15 per Bottle</strong><div class="auto-amount" id="water-total">Total: ₹0</div></div>
                <button type="submit" data-lang="add_water_btn">Add Water Entry</button>
            </form>
        </section>

        <section id="extra" class="tab-content" style="display:none;">
            <h2 data-lang="add_extra">Add Extra Expense</h2>
            <form id="extra-form">
                <input type="date" id="extra-date" required>
                <select id="extra-category" required>
                    <option value="" disabled selected>Select Category</option>
                    <option>Utensils</option><option>Repairs</option><option>Electricity Bill</option>
                    <option>Mobile Bill</option><option>Gas Bill</option><option>Event</option>
                    <option>Grocery</option><option>Other</option>
                </select>
                <input type="text" id="extra-desc" placeholder="Description" required>
                <input type="number" id="extra-amount" placeholder="Amount (₹)" min="0" step="0.01" required>
                <input type="file" id="extra-photos" accept="image/*" multiple>
                <div id="extra-photo-preview" class="photo-gallery"></div>
                <button type="submit" class="save-btn">Add Extra Expense</button>
            </form>
        </section>

        <!-- Calendar View -->
        <section id="calendar" class="tab-content" style="display:none;">
            <div class="filter">
                <label data-lang="filter_month">Month:</label>
                <select id="cal-month" onchange="renderCalendar()"></select>
                <label data-lang="filter_year">Year:</label>
                <select id="cal-year" onchange="renderCalendar()"></select>
            </div>
            <div id="calendar-container"></div>
        </section>

        <!-- List View -->
        <section id="lists" class="tab-content" style="display:none;">
            <div class="filter">
                <label data-lang="filter_month">Month:</label>
                <select id="list-month" onchange="renderLists()"></select>
                <label data-lang="filter_year">Year:</label>
                <select id="list-year" onchange="renderLists()"></select>
            </div>
            <h2 data-lang="milk_entries">Milk Entries</h2><div id="milk-list"></div>
            <h2 data-lang="water_entries">Water Entries</h2><div id="water-list"></div>
            <h2 data-lang="extra_entries">Extra Expenses</h2>
            <div id="extra-total" class="month-total" style="display:none;"></div>
            <div id="extra-list"></div>
            <div id="list-grand-total" class="grand-total" style="display:none;"></div>
        </section>
    </div>

    <div id="photo-modal" class="modal" onclick="this.style.display='none'">
        <span class="close-modal">&times;</span>
        <div class="modal-content">
            <img id="modal-photo" style="max-width:90%; max-height:80vh;" src="" alt="Photo">
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCFs97XtLPQE3nASwvtLBUcfH6E8-SIns",
            authDomain: "studio-7486561707-a8f94.firebaseapp.com",
            projectId: "studio-7486561707-a8f94",
            storageBucket: "studio-7486561707-a8f94.firebasestorage.app",
            messagingSenderId: "671038061779",
            appId: "1:671038061779:web:1fc69c9d4e47bc373f6826"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const DATA_DOC = "shared_expenses/data";
        const APP_PASSWORD = "HE";

        let milkEntries = [], waterEntries = [], extraEntries = [], monthlyChart = null;
        const MILK_PRICE = 60, WATER_PRICE = 15;

        const translations = {
            en: {
                title: "Home Expanses",
                login_title: "Home Expanses Login",
                login_btn: "Login",
                wrong_password: "Incorrect password!",
                dark_mode: "Dark Mode",
                Dashboard: "Dashboard",
                add_milk: "Add Milk",
                add_water: "Add Water",
                add_extra: "Add Extra Expense",
                calendar_view: "Calendar View",
                list_view: "List View",
                filter_month: "Month:",
                filter_year: "Year:",
                total_milk_ltr: "Total Milk (Ltr)",
                milk_expense: "Milk Expense",
                total_water_btl: "Total Water (Btl)",
                water_expense: "Water Expense",
                extra_expense: "Extra Expenses",
                total_expense: "Grand Total",
                milk_price: "Fixed Price: ₹60 per Liter",
                water_price: "Fixed Price: ₹15 per Bottle",
                add_milk_btn: "Add Milk Entry",
                add_water_btn: "Add Water Entry",
                milk_entries: "Milk Entries",
                water_entries: "Water Entries",
                extra_entries: "Extra Expenses",
                download_milk_pdf: "Milk PDF",
                download_water_pdf: "Water PDF",
                download_extra_pdf: "Extra PDF"
            },
            hi: {
                title: "होम खर्च",
                login_title: "होम खर्च लॉगिन",
                login_btn: "लॉगिन",
                wrong_password: "गलत पासवर्ड!",
                dark_mode: "डार्क मोड",
                Dashboard: "डैशबोर्ड",
                add_milk: "दूध जोड़ें",
                add_water: "पानी जोड़ें",
                add_extra: "अतिरिक्त खर्च जोड़ें",
                calendar_view: "कैलेंडर दृश्य",
                list_view: "सूची दृश्य",
                filter_month: "माह:",
                filter_year: "वर्ष:",
                total_milk_ltr: "कुल दूध (लीटर)",
                milk_expense: "दूध खर्च",
                total_water_btl: "कुल पानी (बोतल)",
                water_expense: "पानी खर्च",
                extra_expense: "अतिरिक्त खर्च",
                total_expense: "कुल योग",
                milk_entries: "दूध प्रविष्टियाँ",
                water_entries: "पानी प्रविष्टियाँ",
                extra_entries: "अतिरिक्त खर्च"
            },
            gu: {
                title: "ઘર ખર્ચ",
                login_title: "ઘર ખર્ચ લોગિન",
                login_btn: "લોગિન",
                wrong_password: "ખોટો પાસવર્ડ!",
                dark_mode: "ડાર્ક મોડ",
                Dashboard: "ડૅશબોર્ડ",
                add_milk: "દૂધ ઉમેરો",
                add_water: "પાણી ઉમેરો",
                add_extra: "અતિરિક્ત ખર્ચ ઉમેરો",
                calendar_view: "કૅલેન્ડર દૃશ્ય",
                list_view: "યાદી દૃશ્ય",
                filter_month: "મહિનો:",
                filter_year: "વર્ષ:",
                total_milk_ltr: "કુલ દૂધ (લિટર)",
                milk_expense: "દૂધ ખર્ચ",
                total_water_btl: "કુલ પાણી (બોટલ)",
                water_expense: "પાણી ખર્ચ",
                extra_expense: "અતિરિક્ત ખર્ચ",
                total_expense: "કુલ યોગ",
                milk_entries: "દૂધ એન્ટ્રીઓ",
                water_entries: "પાણી એન્ટ્રીઓ",
                extra_entries: "અતિરિક્ત ખર્ચ"
            }
        };

        let currentLang = 'en';

        async function loadData() {
            try {
                const doc = await db.doc(DATA_DOC).get();
                if (doc.exists) {
                    const data = doc.data();
                    milkEntries = data.milkEntries || [];
                    waterEntries = data.waterEntries || [];
                    extraEntries = data.extraEntries || [];
                }
                document.getElementById('sync-status').textContent = "Data synced!";
                document.getElementById('sync-status').style.color = "#27ae60";
            } catch (err) {
                document.getElementById('sync-status').textContent = "Offline – changes will sync later";
                document.getElementById('sync-status').style.color = "#e67e22";
            }
            initApp();
        }

        async function saveData() {
            try {
                await db.doc(DATA_DOC).set({
                    milkEntries,
                    waterEntries,
                    extraEntries
                });
            } catch (err) { console.error("Save error:", err); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const loginPage = document.getElementById('login-page');
            const mainApp = document.getElementById('main-app');
            const logoutBtn = document.getElementById('logout-btn');

            if (isLoggedIn) {
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                logoutBtn.style.display = 'block';
                loadData();
            } else {
                loginPage.style.display = 'flex';
                mainApp.style.display = 'none';
            }

            document.getElementById('login-btn').addEventListener('click', () => {
                if (document.getElementById('login-password').value === APP_PASSWORD) {
                    localStorage.setItem('isLoggedIn', 'true');
                    loginPage.style.display = 'none';
                    mainApp.style.display = 'block';
                    logoutBtn.style.display = 'block';
                    loadData();
                } else {
                    document.getElementById('login-error').style.display = 'block';
                }
            });

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('isLoggedIn');
                location.reload();
            });
        });

        function initApp() {
            const today = new Date().toISOString().split('T')[0];
            ['milk', 'water', 'extra'].forEach(id => document.getElementById(id + '-date').value = today);

            currentLang = localStorage.getItem('preferredLanguage') || 'en';
            document.getElementById('language-select').value = currentLang;
            translatePage();

            populateYearMonthSelects();
            openTab('dashboard');
        }

        function translatePage() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (translations[currentLang] && translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });
        }

        function changeLanguage() {
            currentLang = document.getElementById('language-select').value;
            localStorage.setItem('preferredLanguage', currentLang);
            translatePage();
            populateYearMonthSelects();
            updateDashboard();
            renderCalendar();
            renderLists();
        }

        function populateYearMonthSelects() {
            const years = new Set([new Date().getFullYear()]);
            [...milkEntries, ...waterEntries, ...extraEntries].forEach(e => {
                const d = new Date(e.date);
                years.add(d.getFullYear());
            });

            ['dashboard', 'cal', 'list'].forEach(prefix => {
                const yearSel = document.getElementById(prefix + '-year');
                const monthSel = document.getElementById(prefix + '-month');
                yearSel.innerHTML = `<option value="all">All Years</option>`;
                monthSel.innerHTML = `<option value="all">All Months</option>`;
                Array.from(years).sort((a,b)=>b-a).forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y; opt.textContent = y;
                    if (y === new Date().getFullYear()) opt.selected = true;
                    yearSel.appendChild(opt);
                });
                for (let i = 0; i < 12; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = new Date(2020, i).toLocaleString('default', { month: 'long' });
                    if (i === new Date().getMonth()) opt.selected = true;
                    monthSel.appendChild(opt);
                };
            });
        }

        // Preview multiple photos when adding
        document.getElementById('extra-photos').addEventListener('change', e => {
            const files = e.target.files;
            const preview = document.getElementById('extra-photo-preview');
            preview.innerHTML = '';
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.className = 'photo-preview';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // Add Extra Expense with multiple photos
        document.getElementById('extra-form').addEventListener('submit', async e => {
            e.preventDefault();
            const files = document.getElementById('extra-photos').files;
            const photos = [];
            for (let file of files) {
                const dataUrl = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
                photos.push(dataUrl);
            }

            extraEntries.push({
                date: document.getElementById('extra-date').value,
                category: document.getElementById('extra-category').value,
                description: document.getElementById('extra-desc').value.trim(),
                amount: parseFloat(document.getElementById('extra-amount').value),
                photos: photos
            });

            await saveData();
            e.target.reset();
            document.getElementById('extra-photo-preview').innerHTML = '';
            renderLists();
            updateDashboard();
        });

        // Milk & Water quantity preview and submit
        ['milk', 'water'].forEach(type => {
            document.getElementById(type + '-qty').addEventListener('input', () => {
                const qty = parseFloat(document.getElementById(type + '-qty').value) || 0;
                const price = type === 'milk' ? MILK_PRICE : WATER_PRICE;
                document.getElementById(type + '-total').textContent = `Total: ₹${(qty * price).toFixed(2)}`;
            });

            document.getElementById(type + '-form').addEventListener('submit', async e => {
                e.preventDefault();
                const qty = parseFloat(document.getElementById(type + '-qty').value);
                const entries = type === 'milk' ? milkEntries : waterEntries;
                const price = type === 'milk' ? MILK_PRICE : WATER_PRICE;
                entries.push({
                    date: document.getElementById(type + '-date').value,
                    qty: qty,
                    amount: qty * price
                });
                await saveData();
                e.target.reset();
                document.getElementById(type + '-total').textContent = 'Total: ₹0';
                renderLists();
                updateDashboard();
                renderCalendar();
            });
        });

        function getFilteredEntries(month, year) {
            const isAllMonth = month === 'all';
            const isAllYear = year === 'all';
            const filter = e => {
                const d = new Date(e.date);
                return (isAllMonth || d.getMonth() === parseInt(month)) && (isAllYear || d.getFullYear() === parseInt(year));
            };
            return {
                milk: milkEntries.filter(filter),
                water: waterEntries.filter(filter),
                extra: extraEntries.filter(filter)
            };
        }

        function updateDashboard() {
            const month = document.getElementById('dashboard-month').value;
            const year = document.getElementById('dashboard-year').value;
            const { milk, water, extra } = getFilteredEntries(month, year);

            const milkLtr = milk.reduce((s, e) => s + e.qty, 0);
            const milkAmt = milk.reduce((s, e) => s + e.amount, 0);
            const waterBtl = water.reduce((s, e) => s + e.qty, 0);
            const waterAmt = water.reduce((s, e) => s + e.amount, 0);
            const extraAmt = extra.reduce((s, e) => s + e.amount, 0);

            document.getElementById('dash-milk-ltr').textContent = milkLtr.toFixed(1);
            document.getElementById('dash-milk-amt').textContent = `₹${milkAmt.toFixed(2)}`;
            document.getElementById('dash-water-btl').textContent = waterBtl;
            document.getElementById('dash-water-amt').textContent = `₹${waterAmt.toFixed(2)}`;
            document.getElementById('dash-extra-amt').textContent = `₹${extraAmt.toFixed(2)}`;
            document.getElementById('dash-total').textContent = `₹${(milkAmt + waterAmt + extraAmt).toFixed(2)}`;

            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: ['Milk', 'Water', 'Extra'],
                    datasets: [{
                        label: 'Expense (₹)',
                        data: [milkAmt, waterAmt, extraAmt],
                        backgroundColor: ['#3498db', '#e74c3c', '#9b59b6']
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // PDF Generation with photos in Extra report (up to 3 photos per row)
        function generateMilkPDF() {
            const { milk } = getFilteredEntries(document.getElementById('dashboard-month').value, document.getElementById('dashboard-year').value);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Milk Report', 105, 20, { align: 'center' });
            const body = milk.map(e => [e.date, e.qty.toFixed(1) + ' Ltr', 'Rs ' + e.amount.toFixed(2)]);
            doc.autoTable({ head: [['Date', 'Quantity', 'Amount']], body, startY: 30 });
            doc.text(`Total: Rs ${milk.reduce((s,e)=>s+e.amount,0).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.save('Milk_Report.pdf');
        }

        function generateWaterPDF() {
            const { water } = getFilteredEntries(document.getElementById('dashboard-month').value, document.getElementById('dashboard-year').value);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Water Report', 105, 20, { align: 'center' });
            const body = water.map(e => [e.date, e.qty + ' Btl', 'Rs ' + e.amount.toFixed(2)]);
            doc.autoTable({ head: [['Date', 'Quantity', 'Amount']], body, startY: 30 });
            doc.text(`Total: Rs ${water.reduce((s,e)=>s+e.amount,0).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.save('Water_Report.pdf');
        }

        function generateExtraPDF() {
            const { extra } = getFilteredEntries(document.getElementById('dashboard-month').value, document.getElementById('dashboard-year').value);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // landscape for more space for photos
            doc.text('Extra Expenses Report', 148, 20, { align: 'center' });

            const body = extra.map(e => [e.date, e.category, e.description, 'Rs ' + e.amount.toFixed(2), (e.photos && e.photos.length > 0) ? e.photos.length + ' photo(s)' : 'No photo']);

            doc.autoTable({
                head: [['Date', 'Category', 'Description', 'Amount', 'Photos']],
                body: body,
                startY: 30,
                didDrawCell: (data) => {
                    if (data.column.index === 4 && data.section === 'body' && extra[data.row.index].photos && extra[data.row.index].photos.length > 0) {
                        const photos = extra[data.row.index].photos;
                        let x = data.cell.x + 2;
                        let y = data.cell.y + 2;
                        const imgWidth = 20;
                        const imgHeight = 20;
                        photos.slice(0, 3).forEach(photo => {
                            doc.addImage(photo, 'JPEG', x, y, imgWidth, imgHeight);
                            x += imgWidth + 2;
                            if (x > data.cell.x + data.cell.width - imgWidth) {
                                x = data.cell.x + 2;
                                y += imgHeight + 2;
                            }
                        });
                        if (photos.length > 3) {
                            doc.setFontSize(10);
                            doc.text('...', data.cell.x + data.cell.width - 10, data.cell.y + data.cell.height - 5);
                        }
                    }
                }
            });
            doc.text(`Total: Rs ${extra.reduce((s,e)=>s+e.amount,0).toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
            doc.save('Extra_Report.pdf');
        }

        function renderCalendar() {
            const monthVal = document.getElementById('cal-month').value;
            const yearVal = document.getElementById('cal-year').value;
            const month = monthVal === 'all' ? null : parseInt(monthVal);
            const year = yearVal === 'all' ? null : parseInt(yearVal);

            const container = document.getElementById('calendar-container');
            container.innerHTML = '';

            const allEntries = [...milkEntries.map(e => ({...e, type: 'milk'})), ...waterEntries.map(e => ({...e, type: 'water'}))];

            const filtered = allEntries.filter(e => {
                const d = new Date(e.date);
                return (!month || d.getMonth() === month) && (!year || d.getFullYear() === year);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p>No entries in selected period.</p>';
                return;
            }

            // Group by month/year
            const grouped = {};
            filtered.forEach(e => {
                const d = new Date(e.date);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(e);
            });

            Object.keys(grouped).sort((a,b) => b.localeCompare(a)).forEach(key => {
                const [y, m] = key.split('-').map(Number);
                const monthEntries = grouped[key];

                const monthDiv = document.createElement('div');
                monthDiv.style.marginBottom = '40px';

                const title = document.createElement('h3');
                title.textContent = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
                monthDiv.appendChild(title);

                const header = document.createElement('div');
                header.className = 'calendar-header';
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    const div = document.createElement('div');
                    div.textContent = day;
                    header.appendChild(div);
                });
                monthDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                const firstDay = new Date(y, m, 1).getDay();
                const daysInMonth = new Date(y, m + 1, 0).getDate();

                const dayMap = {};
                monthEntries.forEach(e => {
                    const day = new Date(e.date).getDate();
                    if (!dayMap[day]) dayMap[day] = { milk: 0, water: 0, total: 0 };
                    if (e.type === 'milk') dayMap[day].milk += e.qty;
                    else dayMap[day].water += e.qty;
                    dayMap[day].total += e.amount;
                });

                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    grid.appendChild(empty);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day';
                    if (dayMap[day]) cell.classList.add('has-entry');
                    cell.innerHTML = `<div class="day-number">${day}</div>`;
                    if (dayMap[day]) {
                        const entriesDiv = document.createElement('div');
                        entriesDiv.className = 'day-entries';
                        if (dayMap[day].milk > 0) entriesDiv.innerHTML += `Milk: ${dayMap[day].milk.toFixed(1)}L<br>`;
                        if (dayMap[day].water > 0) entriesDiv.innerHTML += `Water: ${dayMap[day].water}B<br>`;
                        entriesDiv.innerHTML += `₹${dayMap[day].total.toFixed(2)}`;
                        cell.appendChild(entriesDiv);
                    }
                    grid.appendChild(cell);
                }

                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            });
        }

        function renderMilkWaterList(containerId, data, type) {
            const cont = document.getElementById(containerId);
            cont.innerHTML = data.length === 0 ? '<div class="no-data">No entries</div>' : '';

            if (data.length === 0) return;

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Date</th><th>Quantity</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            data.forEach(e => {
                const idx = (type === 'milk' ? milkEntries : waterEntries).indexOf(e);
                const row = document.createElement('tr');
                row.innerHTML = `<td>${e.date}</td><td>${type === 'milk' ? e.qty.toFixed(1) : e.qty} ${type === 'milk' ? 'Ltr' : 'Btl'}</td><td class="amount">₹${e.amount.toFixed(2)}</td><td class="actions"></td>`;
                const actions = row.querySelector('.actions');
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.textContent = 'Delete';
                actions.append(editBtn, delBtn);

                editBtn.onclick = () => {
                    const qtyCell = row.cells[1];
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = e.qty;
                    input.step = type === 'milk' ? '0.5' : '1';
                    qtyCell.innerHTML = '';
                    qtyCell.appendChild(input);

                    editBtn.textContent = 'Save';
                    editBtn.className = 'save-btn';
                    editBtn.onclick = async () => {
                        const newQty = parseFloat(input.value);
                        if (!isNaN(newQty) && newQty >= 0) {
                            const entries = type === 'milk' ? milkEntries : waterEntries;
                            entries[idx].qty = newQty;
                            entries[idx].amount = newQty * (type === 'milk' ? MILK_PRICE : WATER_PRICE);
                            await saveData();
                            renderLists();
                            updateDashboard();
                            renderCalendar();
                        }
                    };

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-btn';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.onclick = () => renderLists();
                    actions.insertBefore(cancelBtn, delBtn);
                    delBtn.style.display = 'none';
                };

                delBtn.onclick = async () => {
                    if (confirm('Delete this entry?')) {
                        (type === 'milk' ? milkEntries : waterEntries).splice(idx, 1);
                        await saveData();
                        renderLists();
                        updateDashboard();
                        renderCalendar();
                    }
                };

                tbody.appendChild(row);
            });
            cont.appendChild(table);
        }

        function renderExtraList() {
            const month = document.getElementById('list-month').value;
            const year = document.getElementById('list-year').value;
            let filtered = getFilteredEntries(month, year).extra;
            filtered = filtered.sort((a, b) => b.date.localeCompare(a.date));

            const cont = document.getElementById('extra-list');
            cont.innerHTML = filtered.length === 0 ? '<div class="no-data">No extra expenses</div>' : '';

            if (filtered.length === 0) {
                document.getElementById('extra-total').style.display = 'none';
                return;
            }

            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Date</th><th>Category</th><th>Description</th><th class="amount">Amount</th><th>Photos</th><th class="actions">Actions</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            let total = 0;

            filtered.forEach(e => {
                const idx = extraEntries.indexOf(e);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.category}</td>
                    <td>${e.description}</td>
                    <td class="amount">₹${e.amount.toFixed(2)}</td>
                    <td class="photo-gallery"></td>
                    <td class="actions"></td>
                `;
                total += e.amount;

                const photoCell = row.cells[4];
                if (e.photos && e.photos.length > 0) {
                    e.photos.forEach(photo => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'photo-wrapper';
                        const img = document.createElement('img');
                        img.src = photo;
                        img.className = 'photo-preview';
                        img.onclick = () => {
                            document.getElementById('modal-photo').src = photo;
                            document.getElementById('photo-modal').style.display = 'flex';
                        };
                        wrapper.appendChild(img);
                        photoCell.appendChild(wrapper);
                    });
                } else {
                    photoCell.textContent = '-';
                }

                const actions = row.cells[5];
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-btn';
                delBtn.textContent = 'Delete';
                actions.append(editBtn, delBtn);

                editBtn.onclick = () => {
                    const cells = row.cells;

                    const dateInput = document.createElement('input');
                    dateInput.type = 'date';
                    dateInput.value = e.date;
                    cells[0].innerHTML = '';
                    cells[0].appendChild(dateInput);

                    const catSelect = document.createElement('select');
                    ['Utensils','Repairs','Electricity Bill','Mobile Bill','Gas Bill','Event','Grocery','Other'].forEach(c => {
                        const o = document.createElement('option');
                        o.value = c;
                        o.textContent = c;
                        if (c === e.category) o.selected = true;
                        catSelect.appendChild(o);
                    });
                    cells[1].innerHTML = '';
                    cells[1].appendChild(catSelect);

                    const descInput = document.createElement('input');
                    descInput.type = 'text';
                    descInput.value = e.description;
                    cells[2].innerHTML = '';
                    cells[2].appendChild(descInput);

                    const amtInput = document.createElement('input');
                    amtInput.type = 'number';
                    amtInput.step = '0.01';
                    amtInput.value = e.amount;
                    cells[3].innerHTML = '';
                    cells[3].appendChild(amtInput);

                    // Photo editing
                    photoCell.innerHTML = '<input type="file" multiple accept="image/*"><div class="photo-gallery"></div>';
                    const newFileInput = photoCell.querySelector('input');
                    const gallery = photoCell.querySelector('.photo-gallery');

                    // Load current photos with remove button
                    (e.photos || []).forEach(photo => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'photo-wrapper';
                        const img = document.createElement('img');
                        img.src = photo;
                        img.className = 'photo-preview';
                        img.onclick = () => {
                            document.getElementById('modal-photo').src = photo;
                            document.getElementById('photo-modal').style.display = 'flex';
                        };
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-photo-btn';
                        removeBtn.textContent = 'Remove';
                        removeBtn.onclick = (ev) => {
                            ev.stopPropagation();
                            wrapper.remove();
                        };
                        wrapper.append(img, removeBtn);
                        gallery.appendChild(wrapper);
                    });

                    // Preview new photos
                    newFileInput.addEventListener('change', () => {
                        Array.from(newFileInput.files).forEach(file => {
                            const reader = new FileReader();
                            reader.onload = ev => {
                                const wrapper = document.createElement('div');
                                wrapper.className = 'photo-wrapper';
                                const img = document.createElement('img');
                                img.src = ev.target.result;
                                img.className = 'photo-preview';
                                wrapper.appendChild(img);
                                gallery.appendChild(wrapper);
                            };
                            reader.readAsDataURL(file);
                        });
                    });

                    editBtn.textContent = 'Save';
                    editBtn.className = 'save-btn';
                    editBtn.onclick = async () => {
                        const finalPhotos = [];
                        gallery.querySelectorAll('.photo-wrapper').forEach(wrapper => {
                            const img = wrapper.querySelector('img');
                            if (img) finalPhotos.push(img.src);
                        });

                        if (newFileInput.files.length > 0) {
                            for (let file of newFileInput.files) {
                                const dataUrl = await new Promise(r => {
                                    const reader = new FileReader();
                                    reader.onload = () => r(reader.result);
                                    reader.readAsDataURL(file);
                                });
                                finalPhotos.push(dataUrl);
                            }
                        }

                        extraEntries[idx] = {
                            date: dateInput.value,
                            category: catSelect.value,
                            description: descInput.value.trim(),
                            amount: parseFloat(amtInput.value),
                            photos: finalPhotos
                        };

                        await saveData();
                        renderLists();
                        updateDashboard();
                    };

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-btn';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.onclick = () => renderLists();
                    actions.insertBefore(cancelBtn, delBtn);
                    delBtn.style.display = 'none';
                };

                delBtn.onclick = async () => {
                    if (confirm('Delete this extra expense?')) {
                        extraEntries.splice(idx, 1);
                        await saveData();
                        renderLists();
                        updateDashboard();
                    }
                };

                tbody.appendChild(row);
            });

            cont.appendChild(table);
            document.getElementById('extra-total').textContent = `Total Extra: ₹${total.toFixed(2)}`;
            document.getElementById('extra-total').style.display = 'block';
        }

        function renderLists() {
            const month = document.getElementById('list-month').value;
            const year = document.getElementById('list-year').value;
            const { milk, water } = getFilteredEntries(month, year);

            renderMilkWaterList('milk-list', milk, 'milk');
            renderMilkWaterList('water-list', water, 'water');
            renderExtraList();

            const grandTotal = milk.reduce((s,e)=>s+e.amount,0) + water.reduce((s,e)=>s+e.amount,0) +
                extraEntries.filter(e => {
                    const d = new Date(e.date);
                    return (month === 'all' || d.getMonth() === parseInt(month)) && (year === 'all' || d.getFullYear() === parseInt(year));
                }).reduce((s,e)=>s+e.amount,0);

            const grandDiv = document.getElementById('list-grand-total');
            if (grandTotal > 0) {
                grandDiv.textContent = `Grand Total: ₹${grandTotal.toFixed(2)}`;
                grandDiv.style.display = 'block';
            } else {
                grandDiv.style.display = 'none';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'calendar') renderCalendar();
            if (tabName === 'lists') renderLists();
        }
    </script>
</body>
</html>

